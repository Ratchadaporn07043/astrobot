# à¸­à¸˜à¸´à¸šà¸²à¸¢à¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸à¸±à¹ˆà¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¹ˆà¸‡à¸„à¸³à¸–à¸²à¸¡à¹€à¸‚à¹‰à¸²à¸¡à¸²à¸ˆà¸™à¸–à¸¶à¸‡à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸à¸¥à¸±à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰

## ðŸ“‹ à¸ à¸²à¸žà¸£à¸§à¸¡
à¹€à¸­à¸à¸ªà¸²à¸£à¸™à¸µà¹‰à¸­à¸˜à¸´à¸šà¸²à¸¢à¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸‚à¸­à¸‡à¸£à¸°à¸šà¸šà¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´ (Chatbot) à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¹ˆà¸‡à¸„à¸³à¸–à¸²à¸¡à¹€à¸‚à¹‰à¸²à¸¡à¸²à¸ˆà¸™à¸–à¸¶à¸‡à¸£à¸°à¸šà¸šà¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸à¸¥à¸±à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰ à¸žà¸£à¹‰à¸­à¸¡à¸£à¸°à¸šà¸¸à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸—à¸µà¹ˆà¹€à¸à¸´à¸”à¸‚à¸¶à¹‰à¸™à¹ƒà¸™à¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£

---

## ðŸ”„ Flow Diagram à¹à¸šà¸šà¸¥à¸°à¹€à¸­à¸µà¸¢à¸”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¹ˆà¸‡à¸„à¸³à¸–à¸²à¸¡ (User Query)                             â”‚
â”‚     "à¹à¸¥à¹‰à¸§à¸à¸²à¸£à¹€à¸‡à¸´à¸™à¸‚à¸­à¸‡à¸‰à¸±à¸™à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸¢à¸±à¸‡à¹„à¸‡"                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Content Safety Check                                    â”‚
â”‚  (response_message.py:305)                                 â”‚
â”‚  check_content_safety()                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â–¼                         â–¼
    UNSAFE                    SAFE
        â”‚                         â”‚
        â”‚                         â–¼
        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         â”‚  3. Question Limit Check    â”‚
        â”‚         â”‚  check_and_update_question_limit() â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
    EXCEEDED                ALLOWED
        â”‚                       â”‚
        â”‚                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  4. Profile Check/Create    â”‚
        â”‚  get_or_create_user_profile â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
    NEW USER               HAS PROFILE
        â”‚                       â”‚
        â”‚                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  5. Birth Date Extraction   â”‚
        â”‚  extract_birth_info_from_message() â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
    HAS BIRTH              NO BIRTH
        â”‚                       â”‚
        â”‚                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  6. ask_question_to_rag()   â”‚
        â”‚  (retrieval_utils.py:1087)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
   QUESTION LIMIT          CONTINUE
        â”‚                       â”‚
        â”‚                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  7. Get User Context        â”‚
        â”‚  get_user_context()         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
    HAS CONTEXT             NO CONTEXT
        â”‚                       â”‚
        â”‚                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  8. Follow-up Detection     â”‚
        â”‚  check_follow_up_question_with_llm() â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
   FOLLOW-UP               NEW QUESTION
        â”‚                       â”‚
        â”‚                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  9. Chart Info Override    â”‚
        â”‚  (retrieval_utils.py:1111)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
   HAS PROVIDED          NO PROVIDED
        â”‚                       â”‚
        â”‚                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  10. Follow-up Overrides    â”‚
        â”‚  (retrieval_utils.py:1118, 1122, 1128) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
   OVERRIDE               NO OVERRIDE
        â”‚                       â”‚
        â”‚                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  11. Astrology Chart Gen    â”‚
        â”‚  (retrieval_utils.py:1139, 1148) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
   FROM QUESTION          FROM CONTEXT
        â”‚                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  12. Question Enhancement   â”‚
        â”‚  enhance_question_context() â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  13. RAG Retrieval          â”‚
        â”‚  SentenceTransformer + Cosine Similarity â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  14. API Key Check          â”‚
        â”‚  (retrieval_utils.py:1320)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
    HAS API KEY          NO API KEY
        â”‚                       â”‚
        â”‚                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  15. GPT-4 Answer Gen       â”‚
        â”‚  OpenAI GPT-4o-mini         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  16. Store Response         â”‚
        â”‚  store_user_response()      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  17. Return Answer to User  â”‚
        â”‚  (main.py:61)               â”‚
        â”‚  generate_reply_message()   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
              [à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¸£à¸±à¸šà¸„à¸³à¸•à¸­à¸š]
```

---

## ðŸ“ Step-by-Step Process

### **Step 1: à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¹ˆà¸‡à¸„à¸³à¸–à¸²à¸¡ (User Query)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `main.py:58`  
**à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”**: à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¹ˆà¸‡à¸„à¸³à¸–à¸²à¸¡à¸œà¹ˆà¸²à¸™ LINE Messaging API

---

### **Step 2: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¸‚à¸­à¸‡à¹€à¸™à¸·à¹‰à¸­à¸«à¸² (Content Safety Check)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `response_message.py:305` à¸«à¸£à¸·à¸­ `main.py:116`  
**à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™**: `check_content_safety(user_text)`  
**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**:
- **IF** à¸¡à¸µà¸„à¸³à¸«à¸¢à¸²à¸š/à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¹„à¸¡à¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡ â†’ à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹à¸¥à¸°à¸ˆà¸šà¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£
- **ELSE** â†’ à¹„à¸›à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸›

**à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**: **1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚** (à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢/à¹„à¸¡à¹ˆà¸›à¸¥à¸­à¸”à¸ à¸±à¸¢)

---

### **Step 3: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ˆà¸³à¸™à¸§à¸™à¸„à¸³à¸–à¸²à¸¡ (Question Limit Check)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `response_message.py:356`, `main.py:139`, `retrieval_utils.py:1091`  
**à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™**: `check_and_update_question_limit(user_id)`  
**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**:
- **IF** à¸ˆà¸³à¸™à¸§à¸™à¸„à¸³à¸–à¸²à¸¡à¹€à¸à¸´à¸™à¸‚à¸µà¸”à¸ˆà¸³à¸à¸±à¸” (3 à¸„à¸£à¸±à¹‰à¸‡) â†’ à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹à¸¥à¸°à¸ˆà¸šà¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£
- **ELSE** â†’ à¹„à¸›à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸›

**à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**: **1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚** (à¹€à¸à¸´à¸™à¸‚à¸µà¸”à¸ˆà¸³à¸à¸±à¸”/à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™)

---

### **Step 4: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š/à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰ (Profile Check/Create)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `response_message.py:329`  
**à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™**: `get_or_create_user_profile(user_id, user_message)`  
**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**:
- **IF** à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹ƒà¸«à¸¡à¹ˆ (à¹„à¸¡à¹ˆà¸¡à¸µ profile) â†’ à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸•à¹‰à¸­à¸™à¸£à¸±à¸šà¹à¸¥à¸°à¸ˆà¸šà¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£
- **ELSE IF** à¸¡à¸µ profile à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹à¸¥à¸°à¹„à¸¡à¹ˆà¸žà¸šà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ â†’ à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸‚à¸­à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹à¸¥à¸°à¸ˆà¸šà¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£
- **ELSE IF** à¸¡à¸µ profile à¹à¸¥à¸°à¸žà¸šà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ â†’ à¸­à¸±à¸›à¹€à¸”à¸• profile à¹à¸¥à¸°à¹„à¸›à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸›
- **ELSE** â†’ à¹„à¸›à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸› (RAG)

**à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**: **4 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚** (à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹ƒà¸«à¸¡à¹ˆ, à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”, à¸žà¸šà¸§à¸±à¸™à¹€à¸à¸´à¸”, à¸¡à¸µ profile)

---

### **Step 5: à¹à¸¢à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸§à¸±à¸™à¹€à¸à¸´à¸”à¸ˆà¸²à¸à¸„à¸³à¸–à¸²à¸¡ (Birth Date Extraction)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `response_message.py:49`, `retrieval_utils.py:1107`  
**à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™**: `extract_birth_info_from_message(question)`  
**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**:
- **IF** à¸žà¸šà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ â†’ à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹à¸¥à¸°à¹„à¸›à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸›
- **ELSE** â†’ à¹„à¸›à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸›à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸§à¸±à¸™à¹€à¸à¸´à¸”

**à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**: **1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚** (à¸žà¸šà¸§à¸±à¸™à¹€à¸à¸´à¸”/à¹„à¸¡à¹ˆà¸žà¸š)

---

### **Step 6: à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰ ask_question_to_rag()**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1087`  
**à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™**: `ask_question_to_rag(question, user_id, provided_chart_info)`  
**à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”**: à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸«à¸¥à¸±à¸à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸„à¸³à¸–à¸²à¸¡

---

### **Step 7: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ˆà¸³à¸™à¸§à¸™à¸„à¸³à¸–à¸²à¸¡à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡ (à¹ƒà¸™ ask_question_to_rag)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1091`  
**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**:
- **IF** à¸ˆà¸³à¸™à¸§à¸™à¸„à¸³à¸–à¸²à¸¡à¹€à¸à¸´à¸™à¸‚à¸µà¸”à¸ˆà¸³à¸à¸±à¸” â†’ à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹à¸¥à¸°à¸ˆà¸šà¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£
- **ELSE** â†’ à¹„à¸›à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸›

**à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**: **1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚** (à¹€à¸à¸´à¸™à¸‚à¸µà¸”à¸ˆà¸³à¸à¸±à¸”/à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™)

---

### **Step 8: à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸£à¸´à¸šà¸—à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰ (Get User Context)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1097`  
**à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™**: `get_user_context(user_id)`  
**à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”**: à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ MongoDB (user_profiles à¹à¸¥à¸° responses collections)

**à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸”à¸¶à¸‡à¸ˆà¸²à¸ MongoDB**:
- à¸ˆà¸²à¸ `user_profiles` collection:
  - `birth_date` (à¸§à¸±à¸™à¹€à¸à¸´à¸”)
  - `zodiac_sign` (à¸£à¸²à¸¨à¸µ)
  - `zodiac_element` (à¸˜à¸²à¸•à¸¸)
  - `zodiac_quality` (à¸„à¸¸à¸“à¸ à¸²à¸ž)
  - `birth_time` (à¹€à¸§à¸¥à¸²à¹€à¸à¸´à¸”)
  - `daily_question_count` (à¸ˆà¸³à¸™à¸§à¸™à¸„à¸³à¸–à¸²à¸¡à¸•à¹ˆà¸­à¸§à¸±à¸™)
  
- à¸ˆà¸²à¸ `responses` collection:
  - `last_question` (à¸„à¸³à¸–à¸²à¸¡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”)
  - `last_response` (à¸„à¸³à¸•à¸­à¸šà¸¥à¹ˆà¸²à¸ªà¸¸à¸”)
  - `recent_conversations` (à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²à¸¥à¹ˆà¸²à¸ªà¸¸à¸” 5 à¸„à¸£à¸±à¹‰à¸‡)

**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**:
- **IF** à¸žà¸šà¸šà¸£à¸´à¸šà¸— â†’ à¹ƒà¸Šà¹‰à¸šà¸£à¸´à¸šà¸—à¹ƒà¸™à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥
- **ELSE** â†’ à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸— (à¸„à¸³à¸–à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆ)

**à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸**: à¸£à¸°à¸šà¸šà¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ MongoDB à¹à¸•à¹ˆ **à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸§à¹ˆà¸²à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡à¹€à¸›à¹‡à¸™à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸«à¸¡à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ** 
- à¹à¸„à¹ˆà¹€à¸Šà¹‡à¸à¸§à¹ˆà¸² "à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ" (retrieval_utils.py:1121-1123)
- à¸–à¹‰à¸²à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ â†’ à¸–à¸·à¸­à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ new question à¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¹ƒà¸«à¸¡à¹ˆà¹€à¸ªà¸¡à¸­

**à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**: **1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚** (à¸¡à¸µà¸šà¸£à¸´à¸šà¸—/à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸—)

---

### **Step 9: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡ (Follow-up Detection)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1100`  
**à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™**: `check_follow_up_question_with_llm(question, user_context)`  

#### **à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸‚à¸­à¸‡ Follow-up Detection:**

à¸£à¸°à¸šà¸šà¹ƒà¸Šà¹‰ **LLM (OpenAI GPT)** à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸à¹ƒà¸™à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡ à¹‚à¸”à¸¢à¸¡à¸µà¸à¸²à¸£ Fallback à¹„à¸›à¹ƒà¸Šà¹‰ **Semantic Similarity** à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”

#### **à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š:**

**1. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™** (`retrieval_utils.py:1007-1017`):
   - **IF** à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸— (`not user_context or not user_context.get("last_question")`) 
     â†’ `return False` (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-up) - **à¸ˆà¸šà¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸—à¸±à¸™à¸—à¸µ**
   
   - **IF** à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ (à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸”à¹‰à¸§à¸¢ pattern matching: `/`, `-`, `.`, `à¹€à¸”à¸·à¸­à¸™`, `à¸›à¸µ`, `à¸§à¸±à¸™à¹€à¸à¸´à¸”`, `à¹€à¸à¸´à¸”`, à¸Šà¸·à¹ˆà¸­à¹€à¸”à¸·à¸­à¸™à¸•à¹ˆà¸²à¸‡à¹†)
     â†’ `return False` (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-up) - **à¸ˆà¸šà¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸—à¸±à¸™à¸—à¸µ**

**2. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š OpenAI API Key** (`retrieval_utils.py:1020-1027`):
   - **IF** à¹„à¸¡à¹ˆà¸¡à¸µ API key à¸«à¸£à¸·à¸­ API key à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
     â†’ Fallback à¹„à¸›à¹ƒà¸Šà¹‰ `check_follow_up_question_with_semantic_similarity()` (à¹ƒà¸Šà¹‰ embedding similarity)
   - **ELSE** â†’ à¹„à¸›à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸› (à¹ƒà¸Šà¹‰ LLM)

**3. à¹ƒà¸Šà¹‰ LLM à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡** (`retrieval_utils.py:1029-1057`):
   - à¸ªà¸£à¹‰à¸²à¸‡ prompt à¸—à¸µà¹ˆà¸›à¸£à¸°à¸à¸­à¸šà¸”à¹‰à¸§à¸¢:
     - à¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² (`last_question`)
     - à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² (`last_response[:300]...`)
     - à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ (`question`)
   - à¹€à¸à¸“à¸‘à¹Œà¸à¸²à¸£à¸•à¸±à¸”à¸ªà¸´à¸™à¸‚à¸­à¸‡ LLM:
     - **YES** à¸–à¹‰à¸²à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸šà¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²à¸«à¸£à¸·à¸­à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²
     - **YES** à¸–à¹‰à¸²à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸–à¸²à¸¡à¸•à¹ˆà¸­à¸ˆà¸²à¸à¸«à¸±à¸§à¸‚à¹‰à¸­à¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™ (à¹€à¸Šà¹ˆà¸™ à¸–à¸²à¸¡ "à¸„à¸§à¸²à¸¡à¸£à¸±à¸" à¹à¸¥à¹‰à¸§à¸–à¸²à¸¡ "à¸‡à¸²à¸™" à¸•à¹ˆà¸­)
     - **YES** à¸–à¹‰à¸²à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸–à¸²à¸¡à¸•à¹ˆà¸­à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸²à¸¨à¸µà¸—à¸µà¹ˆà¹„à¸”à¹‰
     - **YES** à¸–à¹‰à¸²à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¹€à¸›à¹‡à¸™à¸„à¸³à¸–à¸²à¸¡à¸—à¸±à¹ˆà¸§à¹„à¸›à¸—à¸µà¹ˆà¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸–à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²
     - **NO** à¸–à¹‰à¸²à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸–à¸²à¸¡à¹€à¸£à¸·à¹ˆà¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡
     - **NO** à¸–à¹‰à¸²à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸«à¸¡à¹ˆ
   - à¹€à¸£à¸µà¸¢à¸ LLM à¸”à¹‰à¸§à¸¢:
     - Model: `gpt-4o-mini` (default) à¸«à¸£à¸·à¸­à¸•à¸²à¸¡ `OPENAI_MODEL` env
     - Temperature: `0.1` (à¸•à¹ˆà¸³à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸ªà¸¡à¹ˆà¸³à¹€à¸ªà¸¡à¸­)
     - Max tokens: `10` (à¸•à¸­à¸šà¹à¸„à¹ˆ YES/NO)
   - **IF** LLM à¸•à¸­à¸š "YES" â†’ `return True` (à¹€à¸›à¹‡à¸™ follow-up)
   - **IF** LLM à¸•à¸­à¸š "NO" â†’ `return False` (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-up)

**4. Error Handling** (`retrieval_utils.py:1063-1077`):
   - **IF** à¹€à¸à¸´à¸” error à¹ƒà¸™à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸ LLM
     â†’ Fallback à¹„à¸›à¹ƒà¸Šà¹‰ `check_follow_up_question_with_semantic_similarity()` (à¹ƒà¸Šà¹‰ embedding similarity)
   - **IF** semantic similarity à¸à¹‡ error
     â†’ `return False` (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-up) - à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸£à¸°à¸šà¸šà¸—à¸³à¸‡à¸²à¸™à¸•à¹ˆà¸­à¹„à¸”à¹‰

#### **Semantic Similarity Fallback** (`retrieval_utils.py:850-984`):

à¹€à¸¡à¸·à¹ˆà¸­ LLM à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¹„à¸”à¹‰ à¸£à¸°à¸šà¸šà¸ˆà¸°à¹ƒà¸Šà¹‰ Semantic Similarity à¹à¸—à¸™:

**à¸§à¸´à¸˜à¸µà¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™:**
1. à¹ƒà¸Šà¹‰ SentenceTransformer model: `all-MiniLM-L6-v2`
2. à¸ªà¸£à¹‰à¸²à¸‡ embeddings à¸ªà¸³à¸«à¸£à¸±à¸š:
   - à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
   - à¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² (à¹ƒà¸Šà¹‰ embedding à¸—à¸µà¹ˆà¹€à¸à¹‡à¸šà¹„à¸§à¹‰à¸–à¹‰à¸²à¸¡à¸µ)
   - à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² (à¹ƒà¸Šà¹‰ embedding à¸—à¸µà¹ˆà¹€à¸à¹‡à¸šà¹„à¸§à¹‰à¸–à¹‰à¸²à¸¡à¸µ)
   - à¸šà¸£à¸´à¸šà¸—à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²à¸¥à¹ˆà¸²à¸ªà¸¸à¸” (à¸ˆà¸²à¸ `recent_conversations`)
3. à¸„à¸³à¸™à¸§à¸“ cosine similarity à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸à¸±à¸š:
   - à¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²
   - à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²
   - à¸šà¸£à¸´à¸šà¸—à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²à¸¥à¹ˆà¸²à¸ªà¸¸à¸” (3 à¸„à¸£à¸±à¹‰à¸‡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”)
4. à¸«à¸²à¸„à¹ˆà¸² similarity à¸ªà¸¹à¸‡à¸ªà¸¸à¸” (`max_similarity`)
5. à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸š threshold: `0.25` (default)
   - **IF** `max_similarity >= 0.25` â†’ `return True` (à¹€à¸›à¹‡à¸™ follow-up)
   - **ELSE** â†’ `return False` (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-up)

**à¸‚à¹‰à¸­à¸”à¸µà¸‚à¸­à¸‡à¸à¸²à¸£à¹ƒà¸Šà¹‰ Stored Embeddings:**
- à¸›à¸£à¸°à¸«à¸¢à¸±à¸”à¹€à¸§à¸¥à¸² (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸ªà¸£à¹‰à¸²à¸‡ embedding à¹ƒà¸«à¸¡à¹ˆà¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡)
- à¹ƒà¸Šà¹‰ embedding à¸—à¸µà¹ˆà¹€à¸à¹‡à¸šà¹„à¸§à¹‰à¹ƒà¸™ `responses` collection
- à¸¡à¸µà¸à¸²à¸£ cache `_last_response_obj` à¹ƒà¸™ `user_context`

**à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**: **8 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚** (à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸—, à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”, à¹„à¸¡à¹ˆà¸¡à¸µ API key, LLM YES, LLM NO, LLM Error, Semantic Similarity True, Semantic Similarity False)

---

### **Step 10: Override Chart Info (à¸–à¹‰à¸²à¸¡à¸µ provided_chart_info)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1111`  
**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**:
- **IF** à¸¡à¸µ `provided_chart_info` â†’ à¹ƒà¸Šà¹‰ chart_info à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¸¡à¸² à¹à¸¥à¸°à¸•à¸±à¹‰à¸‡ `is_follow_up_question = False`
- **ELSE** â†’ à¹„à¸›à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸›

**à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**: **1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚** (à¸¡à¸µ provided_chart_info/à¹„à¸¡à¹ˆà¸¡à¸µ)

---

### **Step 11: Override Follow-up Status (à¸«à¸¥à¸²à¸¢à¸ˆà¸¸à¸”)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1118, 1122, 1128`

**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆ 1** (à¸šà¸£à¸£à¸—à¸±à¸” 1118):
- **IF** à¹€à¸›à¹‡à¸™ follow-up à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸—à¹à¸¥à¸°à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸” â†’ `is_follow_up_question = False`

**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆ 2** (à¸šà¸£à¸£à¸—à¸±à¸” 1122):
- **IF** à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ â†’ `is_follow_up_question = False`

**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆ 3** (à¸šà¸£à¸£à¸—à¸±à¸” 1128):
- **IF** à¹€à¸›à¹‡à¸™ follow-up à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¨à¸µà¹ƒà¸™à¸šà¸£à¸´à¸šà¸—à¹à¸¥à¸°à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸” â†’ `is_follow_up_question = False`

**à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**: **3 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**

---

### **Step 12: à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸”à¸§à¸‡à¸Šà¸°à¸•à¸² (Astrology Chart Generation)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1139, 1148`

**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆ 1** (à¸šà¸£à¸£à¸—à¸±à¸” 1139):
- **IF** à¹„à¸¡à¹ˆà¸¡à¸µ `astrology_chart` à¹à¸¥à¸°à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ â†’ à¸ªà¸£à¹‰à¸²à¸‡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¸ˆà¸²à¸à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡

**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆ 2** (à¸šà¸£à¸£à¸—à¸±à¸” 1148):
- **ELSE IF** à¹„à¸¡à¹ˆà¸¡à¸µ `astrology_chart` à¹à¸¥à¸°à¸¡à¸µà¸šà¸£à¸´à¸šà¸—à¹à¸¥à¸°à¸¡à¸µà¸£à¸²à¸¨à¸µà¹à¸¥à¸°à¹€à¸›à¹‡à¸™ follow-up â†’ à¸ªà¸£à¹‰à¸²à¸‡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¸ˆà¸²à¸à¸šà¸£à¸´à¸šà¸—

**à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**: **2 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**

---

### **Step 13: à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹€à¸ˆà¸•à¸™à¸²à¸‚à¸­à¸‡à¸„à¸³à¸–à¸²à¸¡ (Question Intent Analysis)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1191`  
**à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™**: `analyze_question_intent(question)`  
**à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”**: à¸£à¸°à¸šà¸¸à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ personality, love, career, health, finance, lucky_colors à¸«à¸£à¸·à¸­ general

---

### **Step 14: à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸„à¸³à¸–à¸²à¸¡ (Question Enhancement)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1194`  
**à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™**: `enhance_question_context(question, user_context)`  
**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**:
- **IF** `enhanced_question` à¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™ â†’ à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹à¸¥à¸°à¸ˆà¸šà¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£
- **ELSE** â†’ à¹ƒà¸Šà¹‰ `enhanced_question` à¹ƒà¸™à¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²

**à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**: **1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚** (à¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™/à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ)

---

### **Step 15: à¸„à¹‰à¸™à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸”à¹‰à¸§à¸¢ RAG (RAG Retrieval)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1205`  
**à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”**: 
- à¸ªà¸£à¹‰à¸²à¸‡ query embedding à¸”à¹‰à¸§à¸¢ SentenceTransformer
- à¸„à¹‰à¸™à¸«à¸²à¸ˆà¸²à¸ 3 collections: `processed_text_chunks`, `processed_image_chunks`, `processed_table_chunks`
- à¸„à¸³à¸™à¸§à¸“ cosine similarity
- à¹€à¸­à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸¡à¸µ similarity à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 2 à¸­à¸±à¸™à¸”à¸±à¸šà¹à¸£à¸
- Threshold: similarity > 0.2

**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**:
- **IF** à¸žà¸šà¹€à¸­à¸à¸ªà¸²à¸£à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡ (similarity > 0.2) â†’ à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ RAG
- **ELSE** â†’ à¹ƒà¸Šà¹‰à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸—à¸±à¹ˆà¸§à¹„à¸› (No-RAG)

**à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**: **1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚** (à¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥/à¹„à¸¡à¹ˆà¸žà¸š)

---

### **Step 16: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š OpenAI API Key**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1320`  
**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**:
- **IF** à¹„à¸¡à¹ˆà¸¡à¸µ API key â†’ à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹à¸¥à¸°à¸ˆà¸šà¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£
- **ELSE** â†’ à¹„à¸›à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸›

**à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**: **1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚** (à¸¡à¸µ API key/à¹„à¸¡à¹ˆà¸¡à¸µ)

---

### **Step 17: à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¸”à¹‰à¸§à¸¢ GPT-4**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1323`  
**à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”**: 
- à¸ªà¸£à¹‰à¸²à¸‡ prompt à¸—à¸µà¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥:
  - à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸”à¸§à¸‡à¸Šà¸°à¸•à¸² (chart_info)
  - à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ RAG (context_info)
  - à¸šà¸£à¸´à¸šà¸—à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸² (conversation_context)
  - à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆà¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹à¸¥à¹‰à¸§ (enhanced_question)
- à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰ OpenAI GPT-4o-mini

---

### **Step 18: à¸šà¸±à¸™à¸—à¸¶à¸à¸„à¸³à¸•à¸­à¸š (Store Response)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:398` (à¹€à¸£à¸µà¸¢à¸à¸ˆà¸²à¸ `ask_question_to_rag`)  
**à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™**: `store_user_response()`  
**à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”**: 
- à¸šà¸±à¸™à¸—à¸¶à¸à¸„à¸³à¸•à¸­à¸šà¹ƒà¸™ collection `responses`
- à¸­à¸±à¸›à¹€à¸”à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™ collection `user_profiles`
- à¸ªà¸£à¹‰à¸²à¸‡ embeddings à¸ªà¸³à¸«à¸£à¸±à¸š question à¹à¸¥à¸° answer

---

### **Step 19: à¸ªà¹ˆà¸‡à¸„à¸³à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `main.py:61`  
**à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™**: `generate_reply_message(event)`  
**à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”**: à¸ªà¹ˆà¸‡à¸„à¸³à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¹„à¸›à¸¢à¸±à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸œà¹ˆà¸²à¸™ LINE Messaging API

---

## ðŸ“Š à¸ªà¸£à¸¸à¸›à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”

### **à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸«à¸¥à¸±à¸ (Main Conditions)**

1. **Content Safety Check**: 1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚
2. **Question Limit Check**: 2 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚ (à¸•à¸£à¸§à¸ˆ 2 à¸„à¸£à¸±à¹‰à¸‡)
3. **Profile Check/Create**: 4 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚
4. **Birth Date Extraction**: 1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚
5. **Follow-up Detection**: 8 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚ (à¹€à¸žà¸´à¹ˆà¸¡à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”: LLM + Semantic Similarity Fallback)
6. **Chart Info Override**: 1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚
7. **Follow-up Status Overrides**: 3 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚
8. **Astrology Chart Generation**: 2 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚
9. **Question Enhancement**: 1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚
10. **RAG Retrieval**: 1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚
11. **API Key Check**: 1 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚

### **à¸£à¸§à¸¡à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: 25 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚**

---

## ðŸ” à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆà¸ªà¸³à¸„à¸±à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸”

### **1. à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰à¸ˆà¸šà¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£à¸—à¸±à¸™à¸—à¸µ (Early Exit)**
- Content Safety (Step 2)
- Question Limit (Step 3, 7)
- Profile Creation (Step 4)
- Question Enhancement Error (Step 14)
- API Key Missing (Step 16)

### **2. à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¸œà¸¥à¸•à¹ˆà¸­à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥ (Processing Conditions)**
- Follow-up Detection (Step 9)
- Chart Info Override (Step 10)
- Follow-up Status Overrides (Step 11)
- Astrology Chart Generation (Step 12)
- RAG Retrieval (Step 15)

---

## ðŸ“Œ à¸ˆà¸¸à¸”à¸ªà¸³à¸„à¸±à¸

1. **à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸«à¸¥à¸²à¸¢à¸£à¸­à¸š**: à¸£à¸°à¸šà¸šà¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ˆà¸³à¸™à¸§à¸™à¸„à¸³à¸–à¸²à¸¡ 2 à¸„à¸£à¸±à¹‰à¸‡ (à¹ƒà¸™ `response_message.py` à¹à¸¥à¸° `retrieval_utils.py`)

2. **à¸à¸²à¸£ Override Follow-up Status**: à¸¡à¸µà¸à¸²à¸£ override `is_follow_up_question` à¸«à¸¥à¸²à¸¢à¸ˆà¸¸à¸”à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸²à¸à¸²à¸£à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡

3. **Error Handling**: à¸—à¸¸à¸à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸¡à¸µ error handling à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡ à¹‚à¸”à¸¢à¹€à¸‰à¸žà¸²à¸°à¹ƒà¸™ Follow-up Detection à¸—à¸µà¹ˆà¸¡à¸µ fallback mechanism

4. **RAG + GPT-4**: à¸£à¸°à¸šà¸šà¹ƒà¸Šà¹‰ RAG à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡ à¹à¸¥à¸°à¹ƒà¸Šà¹‰ GPT-4 à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡

5. **Context Management**: à¸£à¸°à¸šà¸šà¹€à¸à¹‡à¸šà¸šà¸£à¸´à¸šà¸—à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²à¹„à¸§à¹‰à¹ƒà¸™ MongoDB à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¹ƒà¸™à¸à¸²à¸£à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡

---

## ðŸŽ¯ à¸ªà¸£à¸¸à¸›

à¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸à¸±à¹ˆà¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸¡à¸µà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” **25 à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚** à¸—à¸µà¹ˆà¸„à¸§à¸šà¸„à¸¸à¸¡à¸à¸²à¸£à¹„à¸«à¸¥à¸‚à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¹ˆà¸‡à¸„à¸³à¸–à¸²à¸¡à¹€à¸‚à¹‰à¸²à¸¡à¸²à¸ˆà¸™à¸–à¸¶à¸‡à¸£à¸°à¸šà¸šà¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸à¸¥à¸±à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰ à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¹€à¸«à¸¥à¹ˆà¸²à¸™à¸µà¹‰à¸Šà¹ˆà¸§à¸¢à¹ƒà¸«à¹‰à¸£à¸°à¸šà¸šà¸ªà¸²à¸¡à¸²à¸£à¸–:
- à¸à¸£à¸­à¸‡à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡
- à¸ˆà¸³à¸à¸±à¸”à¸ˆà¸³à¸™à¸§à¸™à¸„à¸³à¸–à¸²à¸¡
- à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡ (à¸”à¹‰à¸§à¸¢ LLM + Semantic Similarity Fallback)
- à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¸•à¸²à¸¡à¸šà¸£à¸´à¸šà¸—
- à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹ƒà¸™à¸­à¸™à¸²à¸„à¸•

### **à¸ˆà¸¸à¸”à¹€à¸”à¹ˆà¸™à¸‚à¸­à¸‡à¸£à¸°à¸šà¸š Follow-up Detection:**

1. **à¹ƒà¸Šà¹‰ LLM à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸**: à¹ƒà¸Šà¹‰ OpenAI GPT à¹€à¸žà¸·à¹ˆà¸­à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸„à¸§à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸‚à¸­à¸‡à¸„à¸³à¸–à¸²à¸¡à¸­à¸¢à¹ˆà¸²à¸‡à¹à¸¡à¹ˆà¸™à¸¢à¸³
2. **à¸¡à¸µ Fallback Mechanism**: à¸«à¸²à¸ LLM à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰ à¸£à¸°à¸šà¸šà¸ˆà¸°à¹ƒà¸Šà¹‰ Semantic Similarity à¹à¸—à¸™
3. **à¹ƒà¸Šà¹‰ Stored Embeddings**: à¸›à¸£à¸°à¸«à¸¢à¸±à¸”à¹€à¸§à¸¥à¸²à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰ embedding à¸—à¸µà¹ˆà¹€à¸à¹‡à¸šà¹„à¸§à¹‰à¹à¸¥à¹‰à¸§à¸ˆà¸²à¸à¸„à¸³à¸–à¸²à¸¡/à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²
4. **à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸«à¸¥à¸²à¸¢à¹à¸«à¸¥à¹ˆà¸‡**: à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸šà¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸², à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸², à¹à¸¥à¸°à¸šà¸£à¸´à¸šà¸—à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
5. **Error Handling à¸—à¸µà¹ˆà¸”à¸µ**: à¸«à¸²à¸à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸” à¸£à¸°à¸šà¸šà¸ˆà¸°à¹„à¸¡à¹ˆà¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§ à¹à¸•à¹ˆà¸ˆà¸°à¸—à¸³à¸‡à¸²à¸™à¸•à¹ˆà¸­à¹„à¸”à¹‰

---

## ðŸ” à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸‚à¸­à¸‡ Follow-up Detection à¹à¸šà¸šà¸¥à¸°à¹€à¸­à¸µà¸¢à¸”

### **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸—à¸µà¹ˆ 1: Follow-up à¸ªà¸³à¹€à¸£à¹‡à¸ˆ (à¹ƒà¸Šà¹‰ LLM)**

**à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œ:**
```
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 1: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2: "à¹à¸¥à¹‰à¸§à¸à¸²à¸£à¹€à¸‡à¸´à¸™à¸‚à¸­à¸‡à¸‰à¸±à¸™à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸¢à¸±à¸‡à¹„à¸‡"
```

**à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™:**
1. **Step 7**: `get_user_context(user_id)` â†’ à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸£à¸´à¸šà¸—
   ```python
   user_context = {
       "zodiac_sign": "à¸à¸¸à¸¡à¸ à¹Œ",
       "birth_date": "09/02/2004",
       "last_question": "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£",
       "last_response": "à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸£à¸²à¸¨à¸µà¸à¸¸à¸¡à¸ à¹Œ à¸‹à¸¶à¹ˆà¸‡à¹€à¸›à¹‡à¸™à¸£à¸²à¸¨à¸µà¸—à¸µà¹ˆà¹€à¸à¸´à¸”à¹ƒà¸™à¸§à¸±à¸™à¸—à¸µà¹ˆ..."
   }
   ```

2. **Step 9**: `check_follow_up_question_with_llm("à¹à¸¥à¹‰à¸§à¸à¸²à¸£à¹€à¸‡à¸´à¸™à¸‚à¸­à¸‡à¸‰à¸±à¸™à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸¢à¸±à¸‡à¹„à¸‡", user_context)`
   - âœ… à¸¡à¸µà¸šà¸£à¸´à¸šà¸— (`user_context.get("last_question")` = "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£")
   - âœ… à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2 (à¹„à¸¡à¹ˆà¸¡à¸µ `/`, `-`, `à¹€à¸”à¸·à¸­à¸™`, `à¸›à¸µ`, à¸Šà¸·à¹ˆà¸­à¹€à¸”à¸·à¸­à¸™)
   - âœ… à¸¡à¸µ OpenAI API key
   - à¸ªà¸£à¹‰à¸²à¸‡ prompt à¹à¸¥à¸°à¹€à¸£à¸µà¸¢à¸ LLM:
     ```
     à¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"
     à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²: "à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸£à¸²à¸¨à¸µà¸à¸¸à¸¡à¸ à¹Œ..."
     à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™: "à¹à¸¥à¹‰à¸§à¸à¸²à¸£à¹€à¸‡à¸´à¸™à¸‚à¸­à¸‡à¸‰à¸±à¸™à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸¢à¸±à¸‡à¹„à¸‡"
     ```
   - LLM à¸•à¸­à¸š: **"YES"** (à¹€à¸›à¹‡à¸™ follow-up à¹€à¸žà¸£à¸²à¸°à¸–à¸²à¸¡à¸•à¹ˆà¸­à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸²à¸¨à¸µà¸—à¸µà¹ˆà¹„à¸”à¹‰)
   - **à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ**: `is_follow_up_question = True`

3. **Step 12**: à¸ªà¸£à¹‰à¸²à¸‡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¸ˆà¸²à¸à¸šà¸£à¸´à¸šà¸— (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸„à¸³à¸™à¸§à¸“à¹ƒà¸«à¸¡à¹ˆ)
   ```python
   astrology_chart = {
       'zodiac_sign': 'à¸à¸¸à¸¡à¸ à¹Œ',
       'birth_date': '09/02/2004',
       ...
   }
   ```

4. **Step 14**: à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸„à¸³à¸–à¸²à¸¡
   ```python
   enhanced_question = "à¸à¸²à¸£à¹€à¸‡à¸´à¸™à¸£à¸²à¸¨à¸µà¸à¸¸à¸¡à¸ à¹Œ à¹à¸¥à¹‰à¸§à¸à¸²à¸£à¹€à¸‡à¸´à¸™à¸‚à¸­à¸‡à¸‰à¸±à¸™à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸¢à¸±à¸‡à¹„à¸‡"
   ```

5. à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¸”à¹‰à¸§à¸¢ GPT-4 à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¸à¸¥à¸±à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰

---

### **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸—à¸µà¹ˆ 2: à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ Follow-up (à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡)**

**à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œ:**
```
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 1: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2: "15/03/1990 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"  â† à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸«à¸¡à¹ˆ
```

**à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™:**
1. **Step 7**: `get_user_context(user_id)` â†’ à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸£à¸´à¸šà¸— (à¸¡à¸µà¸„à¸³à¸–à¸²à¸¡à¹€à¸à¹ˆà¸²)

2. **Step 9**: `check_follow_up_question_with_llm("15/03/1990 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£", user_context)`
   - âœ… à¸¡à¸µà¸šà¸£à¸´à¸šà¸—
   - âŒ **à¸žà¸šà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡** (à¸¡à¸µ `/` à¹à¸¥à¸° `à¸›à¸µ` à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡)
   - **à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ**: `return False` à¸—à¸±à¸™à¸—à¸µ (**à¹„à¸¡à¹ˆà¹€à¸£à¸µà¸¢à¸ LLM**)
   - `is_follow_up_question = False`

3. **Step 11**: Override à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡ (à¸šà¸£à¸£à¸—à¸±à¸” 1122)
   ```python
   if birth_info_from_question and birth_info_from_question.get('date'):
       is_follow_up_question = False  # Override à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡
   ```

4. **Step 12**: à¸ªà¸£à¹‰à¸²à¸‡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¹ƒà¸«à¸¡à¹ˆà¸ˆà¸²à¸à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡
   ```python
   astrology_chart = generate_detailed_astrology_reading(question)
   # à¸ªà¸£à¹‰à¸²à¸‡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¸£à¸²à¸¨à¸µà¹ƒà¸«à¸¡à¹ˆ (à¸£à¸²à¸¨à¸µà¸¡à¸µà¸™)
   ```

5. à¸­à¸±à¸›à¹€à¸”à¸•à¸šà¸£à¸´à¸šà¸—à¹ƒà¸«à¸¡à¹ˆà¹ƒà¸™ `user_profiles` â†’ à¸„à¸³à¸–à¸²à¸¡à¸•à¹ˆà¸­à¹„à¸›à¸ˆà¸°à¹ƒà¸Šà¹‰à¸£à¸²à¸¨à¸µà¹ƒà¸«à¸¡à¹ˆ

---

### **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸—à¸µà¹ˆ 3: LLM Error â†’ Fallback à¹„à¸›à¹ƒà¸Šà¹‰ Semantic Similarity**

**à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œ:**
```
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 1: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2: "à¹à¸¥à¹‰à¸§à¸„à¸§à¸²à¸¡à¸£à¸±à¸à¸‚à¸­à¸‡à¸‰à¸±à¸™à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸¢à¸±à¸‡à¹„à¸‡"
```

**à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™:**
1. **Step 9**: `check_follow_up_question_with_llm(...)`
   - âœ… à¸¡à¸µà¸šà¸£à¸´à¸šà¸—
   - âœ… à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡
   - âœ… à¸¡à¸µ OpenAI API key
   - âŒ **à¹€à¸à¸´à¸” Error à¹ƒà¸™à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸ LLM** (network error, API error, etc.)

2. **Error Handling**: Fallback à¹„à¸›à¹ƒà¸Šà¹‰ `check_follow_up_question_with_semantic_similarity()`
   ```python
   except Exception as e:
       logger.warning(f"Error in LLM follow-up check: {e}")
       # Fallback to semantic similarity
       is_follow_up, _ = check_follow_up_question_with_semantic_similarity(
           question, user_context, similarity_threshold=0.25
       )
       return is_follow_up
   ```

3. **Semantic Similarity Calculation**:
   - à¸ªà¸£à¹‰à¸²à¸‡ embeddings à¸ªà¸³à¸«à¸£à¸±à¸š "à¹à¸¥à¹‰à¸§à¸„à¸§à¸²à¸¡à¸£à¸±à¸à¸‚à¸­à¸‡à¸‰à¸±à¸™à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸¢à¸±à¸‡à¹„à¸‡"
   - à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸š:
     - à¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£" â†’ similarity: 0.15
     - à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²: "à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸£à¸²à¸¨à¸µà¸à¸¸à¸¡à¸ à¹Œ..." â†’ similarity: 0.32
     - max_similarity: **0.32**
   - `0.32 >= 0.25` â†’ **`return True`** (à¹€à¸›à¹‡à¸™ follow-up)

4. **à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ**: `is_follow_up_question = True` (à¸ˆà¸²à¸ semantic similarity)

---

### **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸—à¸µà¹ˆ 4: à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸— â†’ à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ Follow-up**

**à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œ:**
```
à¸„à¸³à¸–à¸²à¸¡à¹à¸£à¸à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹ƒà¸«à¸¡à¹ˆ: "à¸„à¸§à¸²à¸¡à¸£à¸±à¸à¸‚à¸­à¸‡à¸‰à¸±à¸™à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸¢à¸±à¸‡à¹„à¸‡"
```

**à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™:**
1. **Step 7**: `get_user_context(user_id)` â†’ à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹ƒà¸«à¸¡à¹ˆ)
   ```python
   user_context = None  # à¸«à¸£à¸·à¸­ {} (à¹„à¸¡à¹ˆà¸¡à¸µ last_question)
   ```

2. **Step 9**: `check_follow_up_question_with_llm("à¸„à¸§à¸²à¸¡à¸£à¸±à¸à¸‚à¸­à¸‡à¸‰à¸±à¸™à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸¢à¸±à¸‡à¹„à¸‡", None)`
   - âŒ **à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸—** (`not user_context or not user_context.get("last_question")`)
   - **à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ**: `return False` à¸—à¸±à¸™à¸—à¸µ (**à¹„à¸¡à¹ˆà¹€à¸£à¸µà¸¢à¸ LLM**)

3. **Step 12**: à¹„à¸¡à¹ˆà¸¡à¸µà¸”à¸§à¸‡à¸Šà¸°à¸•à¸² â†’ à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¸—à¸±à¹ˆà¸§à¹„à¸›à¸«à¸£à¸·à¸­à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹ƒà¸«à¹‰à¸£à¸°à¸šà¸¸à¸§à¸±à¸™à¹€à¸à¸´à¸”

---

## ðŸ“Š à¸ªà¸£à¸¸à¸› Flow à¸‚à¸­à¸‡ Follow-up Detection

```
à¸„à¸³à¸–à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¸¡à¸²
       â†“
get_user_context(user_id)
       â†“
check_follow_up_question_with_llm()
       â†“
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚       â”‚
à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸—?  à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”?
   â”‚       â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚
  return False (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-up)
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚       â”‚
à¹„à¸¡à¹ˆà¸¡à¸µ API Key?  à¸¡à¸µ API Key
   â”‚       â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚
  à¹ƒà¸Šà¹‰ LLM à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š
       â†“
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚       â”‚
  Error?  Success
   â”‚       â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚
  Fallback â†’ Semantic Similarity
       â†“
  à¸„à¸³à¸™à¸§à¸“ similarity scores
       â†“
  similarity >= 0.25?
       â†“
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚       â”‚
   YES     NO
   â”‚       â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚
  return True/False
```

---

## ðŸ” Flow à¸à¸²à¸£à¹€à¸Šà¹‡à¸à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸„à¸³à¸–à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆ (New Question Detection)

### **à¸ à¸²à¸žà¸£à¸§à¸¡**
à¸£à¸°à¸šà¸šà¸ˆà¸°à¹€à¸Šà¹‡à¸à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ **à¸„à¸³à¸–à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆ (New Question)** à¸«à¸£à¸·à¸­ **à¸„à¸³à¸–à¸²à¸¡à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡ (Follow-up Question)** à¹‚à¸”à¸¢à¸à¸²à¸£à¹€à¸Šà¹‡à¸à¸ˆà¸°à¸—à¸³à¸‡à¸²à¸™à¹à¸šà¸š **inverse** - à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-up à¸à¹‡à¸–à¸·à¸­à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ new question

**à¸ªà¸¹à¸•à¸£à¸à¸²à¸£à¸•à¸±à¸”à¸ªà¸´à¸™**: 
```
is_new_question = NOT is_follow_up_question
```

---

### **Flow Diagram: à¸à¸²à¸£à¹€à¸Šà¹‡à¸ New Question**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  à¸„à¸³à¸–à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¸¡à¸² (Question)                                  â”‚
â”‚  à¸ˆà¸²à¸: ask_question_to_rag()                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸£à¸´à¸šà¸— (get_user_context)                  â”‚
â”‚  à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡: retrieval_utils.py:1096                           â”‚
â”‚  user_context = get_user_context(user_id)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: à¹€à¸£à¸µà¸¢à¸ check_follow_up_question_with_llm()          â”‚
â”‚  à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡: retrieval_utils.py:1099                           â”‚
â”‚  is_follow_up = check_follow_up_question_with_llm(...)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  à¹€à¸Šà¹‡à¸à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™      â”‚
        â”‚  (Early Exit Conditions)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸—?      â”‚    â”‚ à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”        â”‚
â”‚ (à¹„à¸¡à¹ˆà¸¡à¸µ last_     â”‚    â”‚ à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡?        â”‚
â”‚  question)       â”‚    â”‚ (/, -, à¹€à¸”à¸·à¸­à¸™,   â”‚
â”‚                  â”‚    â”‚  à¸›à¸µ, à¸Šà¸·à¹ˆà¸­à¹€à¸”à¸·à¸­à¸™) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚ YES                   â”‚ YES
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ return False    â”‚
            â”‚ (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow- â”‚
            â”‚  up)            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ â­ à¹€à¸›à¹‡à¸™ NEW QUESTION       â”‚
        â”‚ is_new_question = True     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ NO (à¸¡à¸µà¸šà¸£à¸´à¸šà¸—à¹à¸¥à¸°à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”)
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  à¹€à¸Šà¹‡à¸ OpenAI API Key       â”‚
        â”‚  (retrieval_utils.py:1018) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ à¹„à¸¡à¹ˆà¸¡à¸µ API Key?   â”‚    â”‚ à¸¡à¸µ API Key       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚ YES                   â”‚
         â”‚                       â”‚
         â–¼                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ Fallback: Semantic          â”‚ â”‚
â”‚ Similarity                  â”‚ â”‚
â”‚ (check_follow_up_question_  â”‚ â”‚
â”‚  with_semantic_similarity)  â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
         â”‚                      â”‚
         â”‚                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  à¸ªà¸£à¹‰à¸²à¸‡ Embeddings          â”‚
        â”‚  - à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™           â”‚
        â”‚  - à¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²           â”‚
        â”‚  - à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²           â”‚
        â”‚  - Recent conversations    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  à¸„à¸³à¸™à¸§à¸“ Cosine Similarity   â”‚
        â”‚  à¸«à¸² max_similarity         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ similarity >=    â”‚    â”‚ similarity <     â”‚
â”‚ 0.25?            â”‚    â”‚ 0.25?            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚ YES                   â”‚ YES
         â”‚                       â”‚
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ return True      â”‚    â”‚ return False     â”‚
â”‚ (à¹€à¸›à¹‡à¸™ follow-up) â”‚    â”‚ (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-  â”‚
â”‚                  â”‚    â”‚  up)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ â­ à¹€à¸›à¹‡à¸™ NEW QUESTION       â”‚
                    â”‚ is_new_question = True     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ (à¸¡à¸µ API Key)
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  à¹ƒà¸Šà¹‰ LLM à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š           â”‚
                    â”‚  (OpenAI GPT-4o-mini)      â”‚
                    â”‚  à¸ªà¸£à¹‰à¸²à¸‡ prompt:             â”‚
                    â”‚  - à¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²           â”‚
                    â”‚  - à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²           â”‚
                    â”‚  - à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚
                    â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ LLM à¸•à¸­à¸š "YES"?   â”‚    â”‚ LLM à¸•à¸­à¸š "NO"?    â”‚
        â”‚ (à¹€à¸›à¹‡à¸™ follow-up) â”‚    â”‚ (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  up)             â”‚
                 â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                       â”‚
                 â”‚                       â”‚ YES
                 â”‚                       â”‚
                 â–¼                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ return True      â”‚    â”‚ return False     â”‚
        â”‚                  â”‚    â”‚                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ â­ à¹€à¸›à¹‡à¸™ NEW QUESTION       â”‚
                        â”‚ is_new_question = True     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚ (à¹€à¸à¸´à¸” Error)
                                         â”‚
                                         â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  Error Handling            â”‚
                        â”‚  Fallback â†’ Semantic       â”‚
                        â”‚  Similarity                â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  (à¸—à¸³à¸•à¸²à¸¡ flow Semantic      â”‚
                        â”‚   Similarity à¸‚à¹‰à¸²à¸‡à¸šà¸™)       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¸²à¸£à¹€à¸Šà¹‡à¸ New Question (à¹à¸šà¸šà¸¥à¸°à¹€à¸­à¸µà¸¢à¸”)**

#### **ðŸ“ Entry Point: `ask_question_to_rag()`**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1087`  
**à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™**: 

```python
# à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸£à¸´à¸šà¸—
user_context = get_user_context(user_id)

# à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸„à¸³à¸–à¸²à¸¡à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
is_follow_up_question = check_follow_up_question_with_llm(question, user_context)

# à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-up â†’ à¹€à¸›à¹‡à¸™ new question
is_new_question = not is_follow_up_question
```

---

### **ðŸ“‹ à¸ªà¸£à¸¸à¸›: New Question à¹€à¸Šà¹‡à¸à¸­à¸°à¹„à¸£à¹ƒà¸™ MongoDB?**

à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸›à¹‡à¸™ **new question** à¸£à¸°à¸šà¸šà¸ˆà¸°à¹€à¸Šà¹‡à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™ MongoDB à¸”à¸±à¸‡à¸™à¸µà¹‰:

#### **1. à¹€à¸Šà¹‡à¸à¹ƒà¸™ `user_profiles` collection** (`retrieval_utils.py:279`)
```python
user_profile = profiles_collection.find_one({"user_id": user_id})
```

**à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸Šà¹‡à¸:**
- âœ… `birth_date` - à¸§à¸±à¸™à¹€à¸à¸´à¸”à¸—à¸µà¹ˆà¹€à¸à¹‡à¸šà¹„à¸§à¹‰
- âœ… `zodiac_sign` - à¸£à¸²à¸¨à¸µà¸—à¸µà¹ˆà¹€à¸à¹‡à¸šà¹„à¸§à¹‰
- âœ… `zodiac_element` - à¸˜à¸²à¸•à¸¸
- âœ… `zodiac_quality` - à¸„à¸¸à¸“à¸ à¸²à¸ž
- âœ… `birth_time` - à¹€à¸§à¸¥à¸²à¹€à¸à¸´à¸”
- âœ… `daily_question_count` - à¸ˆà¸³à¸™à¸§à¸™à¸„à¸³à¸–à¸²à¸¡à¸•à¹ˆà¸­à¸§à¸±à¸™
- âœ… `last_question_date` - à¸§à¸±à¸™à¸—à¸µà¹ˆà¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
- âœ… `updated_at` - à¸§à¸±à¸™à¸—à¸µà¹ˆà¸­à¸±à¸›à¹€à¸”à¸•à¸¥à¹ˆà¸²à¸ªà¸¸à¸”

#### **2. à¹€à¸Šà¹‡à¸à¹ƒà¸™ `responses` collection** (`retrieval_utils.py:282-292`)
```python
# à¸”à¸¶à¸‡à¸„à¸³à¸•à¸­à¸šà¸¥à¹ˆà¸²à¸ªà¸¸à¸”
latest_response = responses_collection.find_one(
    {"user_id": user_id},
    sort=[("created_at", -1)]
)

# à¸”à¸¶à¸‡à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²à¸¥à¹ˆà¸²à¸ªà¸¸à¸” 5 à¸„à¸£à¸±à¹‰à¸‡
all_responses = list(responses_collection.find(
    {"user_id": user_id},
    sort=[("created_at", -1)],
    limit=5
))
```

**à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸Šà¹‡à¸:**
- âœ… `last_question` - à¸„à¸³à¸–à¸²à¸¡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
- âœ… `last_response` - à¸„à¸³à¸•à¸­à¸šà¸¥à¹ˆà¸²à¸ªà¸¸à¸”
- âœ… `last_response_type` - à¸›à¸£à¸°à¹€à¸ à¸—à¸„à¸³à¸•à¸­à¸š
- âœ… `recent_conversations` - à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²à¸¥à¹ˆà¸²à¸ªà¸¸à¸” 5 à¸„à¸£à¸±à¹‰à¸‡
- âœ… `question_embedding` - Embedding à¸‚à¸­à¸‡à¸„à¸³à¸–à¸²à¸¡ (à¸–à¹‰à¸²à¸¡à¸µ)
- âœ… `answer_embedding` - Embedding à¸‚à¸­à¸‡à¸„à¸³à¸•à¸­à¸š (à¸–à¹‰à¸²à¸¡à¸µ)

#### **3. à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ MongoDB à¹€à¸žà¸·à¹ˆà¸­:**
- âœ… **à¸•à¸±à¸”à¸ªà¸´à¸™à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ follow-up à¸«à¸£à¸·à¸­ new question** - à¹ƒà¸Šà¹‰ `last_question` à¹à¸¥à¸° `last_response`
- âœ… **Follow-up Detection** - à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸›à¹ƒà¸«à¹‰ LLM à¹€à¸žà¸·à¹ˆà¸­à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸„à¸§à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡
- âœ… **Semantic Similarity** - à¹ƒà¸Šà¹‰ embeddings à¹€à¸žà¸·à¹ˆà¸­à¸„à¸³à¸™à¸§à¸“à¸„à¸§à¸²à¸¡à¸„à¸¥à¹‰à¸²à¸¢à¸„à¸¥à¸¶à¸‡
- âœ… **Question Enhancement** - à¹ƒà¸Šà¹‰ `zodiac_sign` à¹€à¸žà¸·à¹ˆà¸­à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸„à¸³à¸–à¸²à¸¡
- âœ… **à¸ªà¸£à¹‰à¸²à¸‡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²** - à¹ƒà¸Šà¹‰ `birth_date` à¹à¸¥à¸° `zodiac_sign` à¸ˆà¸²à¸à¸šà¸£à¸´à¸šà¸— (à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ follow-up)

#### **4. à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸Šà¹‡à¸:**
- âŒ **à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸§à¹ˆà¸²à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡à¹€à¸›à¹‡à¸™à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸«à¸¡à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ**
  - à¹à¸„à¹ˆà¹€à¸Šà¹‡à¸à¸§à¹ˆà¸² "à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ"
  - à¸–à¹‰à¸²à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ â†’ à¸–à¸·à¸­à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ new question à¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¹ƒà¸«à¸¡à¹ˆà¹€à¸ªà¸¡à¸­
  - à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹ƒà¸Šà¹‰ `user_context.birth_date` à¹€à¸žà¸·à¹ˆà¸­à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸š

#### **5. Flow à¸à¸²à¸£à¹€à¸Šà¹‡à¸:**
```
ask_question_to_rag()
    â†“
get_user_context(user_id)  â† à¹€à¸Šà¹‡à¸ MongoDB
    â†“
    â”œâ”€ user_profiles.find_one({"user_id": user_id})
    â”œâ”€ responses.find_one({"user_id": user_id}, sort=[("created_at", -1)])
    â””â”€ responses.find({"user_id": user_id}, sort=[("created_at", -1)], limit=5)
    â†“
check_follow_up_question_with_llm(question, user_context)
    â†“
    â”œâ”€ à¹€à¸Šà¹‡à¸: à¸¡à¸µ last_question à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ? â†’ à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ â†’ return False (new question)
    â”œâ”€ à¹€à¸Šà¹‡à¸: à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ? â†’ à¸–à¹‰à¸²à¸¡à¸µ â†’ return False (new question)
    â””â”€ à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ â†’ à¹ƒà¸Šà¹‰ LLM/Semantic Similarity à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ
    â†“
is_new_question = not is_follow_up_question
```

**à¸ªà¸£à¸¸à¸›**: à¸£à¸°à¸šà¸šà¹€à¸Šà¹‡à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™ MongoDB à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¶à¸‡à¸šà¸£à¸´à¸šà¸—à¹à¸¥à¸°à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸² à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸§à¹ˆà¸²à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹€à¸›à¹‡à¸™à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸«à¸¡à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ à¹à¸„à¹ˆà¹€à¸Šà¹‡à¸à¸§à¹ˆà¸² "à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ"

---

## ðŸ” Flow à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ Follow-up à¸«à¸£à¸·à¸­ New Question

### **à¸ à¸²à¸žà¸£à¸§à¸¡**
à¸£à¸°à¸šà¸šà¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ **Follow-up Question** à¸«à¸£à¸·à¸­ **New Question** à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰à¸«à¸¥à¸²à¸¢à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™:

1. **Early Exit Checks** - à¹€à¸Šà¹‡à¸à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™ (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰ LLM)
2. **LLM Detection** - à¹ƒà¸Šà¹‰ OpenAI GPT à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸„à¸§à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡ (Primary Method)
3. **Semantic Similarity** - à¹ƒà¸Šà¹‰ Embedding Similarity (Fallback Method)
4. **Post-Processing Override** - Override à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¸•à¸²à¸¡à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡

---

### **ðŸ“Š Flow Diagram: à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Follow-up vs New Question**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  à¸„à¸³à¸–à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¸¡à¸² (Question)                                  â”‚
â”‚  à¸ˆà¸²à¸: ask_question_to_rag()                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸£à¸´à¸šà¸— (get_user_context)                  â”‚
â”‚  user_context = get_user_context(user_id)                   â”‚
â”‚  - à¹€à¸Šà¹‡à¸ MongoDB: user_profiles, responses                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: à¹€à¸£à¸µà¸¢à¸ check_follow_up_question_with_llm()          â”‚
â”‚  is_follow_up = check_follow_up_question_with_llm(...)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Early Exit Check #1       â”‚
        â”‚  à¸¡à¸µ last_question à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ? â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ à¹„à¸¡à¹ˆà¸¡à¸µ            â”‚    â”‚ à¸¡à¸µ               â”‚
â”‚ last_question    â”‚    â”‚ last_question    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚                       â–¼
         â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚          â”‚  Early Exit Check #2       â”‚
         â”‚          â”‚  à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?  â”‚
         â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚          â”‚                         â”‚
         â”‚          â–¼                         â–¼
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  â”‚ à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”        â”‚    â”‚ à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”     â”‚
         â”‚  â”‚ à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡         â”‚    â”‚ à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡         â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚                       â”‚
         â”‚           â”‚                       â–¼
         â”‚           â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚          â”‚  à¹€à¸Šà¹‡à¸ OpenAI API Key       â”‚
         â”‚           â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚                       â”‚
         â”‚           â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚          â”‚                         â”‚
         â”‚           â”‚          â–¼                         â–¼
         â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚  â”‚ à¹„à¸¡à¹ˆà¸¡à¸µ API Key    â”‚    â”‚ à¸¡à¸µ API Key       â”‚
         â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚           â”‚                       â”‚
         â”‚           â”‚           â”‚                       â–¼
         â”‚           â”‚           â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚           â”‚          â”‚  à¹ƒà¸Šà¹‰ LLM à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š           â”‚
         â”‚           â”‚           â”‚          â”‚  (OpenAI GPT-4o-mini)      â”‚
         â”‚           â”‚           â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚           â”‚                       â”‚
         â”‚           â”‚           â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚           â”‚          â”‚                         â”‚
         â”‚           â”‚           â”‚          â–¼                         â–¼
         â”‚           â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚           â”‚  â”‚ LLM à¸•à¸­à¸š "YES"    â”‚    â”‚ LLM à¸•à¸­à¸š "NO"     â”‚
         â”‚           â”‚           â”‚  â”‚ (à¹€à¸›à¹‡à¸™ follow-up) â”‚    â”‚ (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-  â”‚
         â”‚           â”‚           â”‚  â”‚                  â”‚    â”‚  up)             â”‚
         â”‚           â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚           â”‚           â”‚                       â”‚
         â”‚           â”‚           â”‚           â”‚                       â”‚
         â”‚           â”‚           â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚           â”‚                       â”‚
         â”‚           â”‚           â”‚                       â–¼
         â”‚           â”‚           â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚           â”‚          â”‚  Fallback: Semantic        â”‚
         â”‚           â”‚           â”‚          â”‚  Similarity                â”‚
         â”‚           â”‚           â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚           â”‚                       â”‚
         â”‚           â”‚           â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚           â”‚          â”‚                         â”‚
         â”‚           â”‚           â”‚          â–¼                         â–¼
         â”‚           â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚           â”‚  â”‚ similarity >=    â”‚    â”‚ similarity <     â”‚
         â”‚           â”‚           â”‚  â”‚ 0.25?            â”‚    â”‚ 0.25?            â”‚
         â”‚           â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚           â”‚           â”‚                       â”‚
         â”‚           â”‚           â”‚           â”‚ YES                   â”‚ YES
         â”‚           â”‚           â”‚           â”‚                       â”‚
         â”‚           â”‚           â”‚           â–¼                       â–¼
         â”‚           â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚           â”‚  â”‚ return True      â”‚    â”‚ return False     â”‚
         â”‚           â”‚           â”‚  â”‚ (follow-up)      â”‚    â”‚ (new question)   â”‚
         â”‚           â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚           â”‚
         â”‚           â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚                       â”‚
         â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  Post-Processing Override  â”‚
                            â”‚  (retrieval_utils.py:      â”‚
                            â”‚   1110, 1117, 1121, 1127)  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚                         â”‚
                            â–¼                         â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Override à¹€à¸›à¹‡à¸™    â”‚    â”‚ à¹„à¸¡à¹ˆ Override     â”‚
                â”‚ new question     â”‚    â”‚ (à¹ƒà¸Šà¹‰à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¹€à¸”à¸´à¸¡) â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚                       â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢            â”‚
                    â”‚  is_follow_up_question     â”‚
                    â”‚  = True (Follow-up)        â”‚
                    â”‚  à¸«à¸£à¸·à¸­                      â”‚
                    â”‚  = False (New Question)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **ðŸ” à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸šà¸šà¸¥à¸°à¹€à¸­à¸µà¸¢à¸”**

#### **Step 1: Early Exit Check #1 - à¹€à¸Šà¹‡à¸à¸§à¹ˆà¸²à¸¡à¸µ last_question à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1003-1004`

```python
if not user_context or not user_context.get("last_question"):
    return False  # â† à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-up = à¹€à¸›à¹‡à¸™ NEW QUESTION
```

**à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ**:
- âœ… **à¹„à¸¡à¹ˆà¸¡à¸µ `last_question`** â†’ `return False` â†’ **NEW QUESTION**
- âœ… **à¸¡à¸µ `last_question`** â†’ à¹„à¸›à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸›

---

#### **Step 2: Early Exit Check #2 - à¹€à¸Šà¹‡à¸à¸§à¹ˆà¸²à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1007-1014`

```python
has_birth_date_in_question = any(pattern in question for pattern in [
    "/", "-", ".", "à¹€à¸”à¸·à¸­à¸™", "à¸›à¸µ", "à¸§à¸±à¸™à¹€à¸à¸´à¸”", "à¹€à¸à¸´à¸”", 
    "à¸¡à¸à¸£à¸²à¸„à¸¡", "à¸à¸¸à¸¡à¸ à¸²à¸žà¸±à¸™à¸˜à¹Œ", "à¸¡à¸µà¸™à¸²à¸„à¸¡", ... (à¸Šà¸·à¹ˆà¸­à¹€à¸”à¸·à¸­à¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”)
])

if has_birth_date_in_question:
    return False  # â† à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-up = à¹€à¸›à¹‡à¸™ NEW QUESTION
```

**à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ**:
- âœ… **à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡** â†’ `return False` â†’ **NEW QUESTION**
- âœ… **à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡** â†’ à¹„à¸›à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸›

---

#### **Step 3: à¹€à¸Šà¹‡à¸ OpenAI API Key**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1018-1025`

```python
openai_key = os.getenv("OPENAI_API_KEY")
if not openai_key or openai_key == "your-openai-api-key-here":
    # Fallback à¹„à¸›à¹ƒà¸Šà¹‰ Semantic Similarity
    is_follow_up, _ = check_follow_up_question_with_semantic_similarity(
        question, user_context, similarity_threshold=0.25
    )
    return is_follow_up
```

**à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ**:
- âœ… **à¹„à¸¡à¹ˆà¸¡à¸µ API Key** â†’ à¹ƒà¸Šà¹‰ **Semantic Similarity** (à¸”à¸¹ Step 5)
- âœ… **à¸¡à¸µ API Key** â†’ à¹ƒà¸Šà¹‰ **LLM** (à¸”à¸¹ Step 4)

---

#### **Step 4: à¹ƒà¸Šà¹‰ LLM à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š (Primary Method)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1029-1072`

**à¸§à¸´à¸˜à¸µà¸à¸²à¸£**:
1. à¸ªà¸£à¹‰à¸²à¸‡ prompt à¸—à¸µà¹ˆà¸¡à¸µ:
   - à¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² (`last_question`)
   - à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² (`last_response[:300]`)
   - à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ (`question`)

2. à¹€à¸£à¸µà¸¢à¸ LLM:
   ```python
   response = client.chat.completions.create(
       model="gpt-4o-mini",
       messages=[...],
       temperature=0.1,
       max_tokens=10
   )
   ```

3. à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆ:
   ```python
   result = response.choices[0].message.content.strip().upper()
   is_follow_up = result == "YES"
   ```

**à¹€à¸à¸“à¸‘à¹Œà¸à¸²à¸£à¸•à¸±à¸”à¸ªà¸´à¸™à¸‚à¸­à¸‡ LLM**:
- âœ… **YES** (Follow-up) à¸–à¹‰à¸²:
  - à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸šà¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²à¸«à¸£à¸·à¸­à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²
  - à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸–à¸²à¸¡à¸•à¹ˆà¸­à¸ˆà¸²à¸à¸«à¸±à¸§à¸‚à¹‰à¸­à¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™
  - à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸–à¸²à¸¡à¸•à¹ˆà¸­à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸²à¸¨à¸µà¸—à¸µà¹ˆà¹„à¸”à¹‰
  - à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¹€à¸›à¹‡à¸™à¸„à¸³à¸–à¸²à¸¡à¸—à¸±à¹ˆà¸§à¹„à¸›à¸—à¸µà¹ˆà¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸–à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²

- âœ… **NO** (New Question) à¸–à¹‰à¸²:
  - à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸–à¸²à¸¡à¹€à¸£à¸·à¹ˆà¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡
  - à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸«à¸¡à¹ˆ

**à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ**:
- âœ… **LLM à¸•à¸­à¸š "YES"** â†’ `return True` â†’ **FOLLOW-UP**
- âœ… **LLM à¸•à¸­à¸š "NO"** â†’ `return False` â†’ **NEW QUESTION**
- âŒ **à¹€à¸à¸´à¸” Error** â†’ Fallback à¹„à¸›à¹ƒà¸Šà¹‰ Semantic Similarity

---

#### **Step 5: Semantic Similarity (Fallback Method)**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:850-984`

**à¸§à¸´à¸˜à¸µà¸à¸²à¸£**:
1. à¸ªà¸£à¹‰à¸²à¸‡ embeddings:
   - à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
   - à¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² (à¹ƒà¸Šà¹‰ embedding à¸—à¸µà¹ˆà¹€à¸à¹‡à¸šà¹„à¸§à¹‰à¸–à¹‰à¸²à¸¡à¸µ)
   - à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² (à¹ƒà¸Šà¹‰ embedding à¸—à¸µà¹ˆà¹€à¸à¹‡à¸šà¹„à¸§à¹‰à¸–à¹‰à¸²à¸¡à¸µ)
   - Recent conversations (3 à¸„à¸£à¸±à¹‰à¸‡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”)

2. à¸„à¸³à¸™à¸§à¸“ cosine similarity:
   ```python
   max_similarity = max(all_similarity_scores)
   ```

3. à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆ:
   ```python
   if max_similarity >= 0.25:
       return True   # FOLLOW-UP
   else:
       return False  # NEW QUESTION
   ```

**à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ**:
- âœ… **similarity >= 0.25** â†’ `return True` â†’ **FOLLOW-UP**
- âœ… **similarity < 0.25** â†’ `return False` â†’ **NEW QUESTION**

---

#### **Step 6: Post-Processing Override**
**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1110, 1117, 1121, 1127`

à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¹„à¸”à¹‰ `is_follow_up_question` à¹à¸¥à¹‰à¸§ à¸£à¸°à¸šà¸šà¸ˆà¸° override à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡:

**Override 1** (à¸šà¸£à¸£à¸—à¸±à¸” 1110):
```python
if provided_chart_info:
    is_follow_up_question = False  # â† à¹€à¸›à¹‡à¸™ NEW QUESTION
```

**Override 2** (à¸šà¸£à¸£à¸—à¸±à¸” 1117):
```python
if is_follow_up_question and not user_context and not birth_info:
    is_follow_up_question = False  # â† à¹€à¸›à¹‡à¸™ NEW QUESTION
```

**Override 3** (à¸šà¸£à¸£à¸—à¸±à¸” 1121):
```python
if birth_info_from_question and birth_info_from_question.get('date'):
    is_follow_up_question = False  # â† à¹€à¸›à¹‡à¸™ NEW QUESTION
```

**Override 4** (à¸šà¸£à¸£à¸—à¸±à¸” 1127):
```python
if is_follow_up_question and user_context and not user_zodiac and not birth_info:
    is_follow_up_question = False  # â† à¹€à¸›à¹‡à¸™ NEW QUESTION
```

---

### **ðŸ“Š à¸ªà¸£à¸¸à¸›à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™ New Question**

| à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚ | à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ | à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ |
|---------|---------|---------|
| à¹„à¸¡à¹ˆà¸¡à¸µ `last_question` | `retrieval_utils.py:1003` | âœ… NEW QUESTION |
| à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ (pattern matching) | `retrieval_utils.py:1007-1014` | âœ… NEW QUESTION |
| LLM à¸•à¸­à¸š "NO" | `retrieval_utils.py:1065` | âœ… NEW QUESTION |
| Semantic Similarity < 0.25 | `retrieval_utils.py:970` | âœ… NEW QUESTION |
| à¸¡à¸µ `provided_chart_info` | `retrieval_utils.py:1110` | âœ… NEW QUESTION |
| à¹€à¸›à¹‡à¸™ follow-up à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸— | `retrieval_utils.py:1117` | âœ… NEW QUESTION |
| à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ (à¸«à¸¥à¸±à¸‡ extract) | `retrieval_utils.py:1121` | âœ… NEW QUESTION |
| à¹€à¸›à¹‡à¸™ follow-up à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¨à¸µ | `retrieval_utils.py:1127` | âœ… NEW QUESTION |
| Error à¸—à¸±à¹‰à¸‡ LLM à¹à¸¥à¸° Semantic | `retrieval_utils.py:1083` | âœ… NEW QUESTION |

---

### **ðŸ“Š à¸ªà¸£à¸¸à¸›à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™ Follow-up**

| à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚ | à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ | à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ |
|---------|---------|---------|
| LLM à¸•à¸­à¸š "YES" | `retrieval_utils.py:1065` | âœ… FOLLOW-UP |
| Semantic Similarity >= 0.25 | `retrieval_utils.py:970` | âœ… FOLLOW-UP |

---

### **ðŸŽ¯ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™**

#### **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ 1: New Question (à¹„à¸¡à¹ˆà¸¡à¸µ last_question)**
```
à¸„à¸³à¸–à¸²à¸¡: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"
user_context: None à¸«à¸£à¸·à¸­ {} (à¹„à¸¡à¹ˆà¸¡à¸µ last_question)

Flow:
1. Early Exit Check #1 â†’ à¹„à¸¡à¹ˆà¸¡à¸µ last_question â†’ return False
2. is_new_question = True âœ…
```

#### **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ 2: New Question (à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡)**
```
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 1: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2: "15/03/1990 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"

Flow:
1. Early Exit Check #1 â†’ à¸¡à¸µ last_question â†’ à¹„à¸›à¸•à¹ˆà¸­
2. Early Exit Check #2 â†’ à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ â†’ return False
3. is_new_question = True âœ…
```

#### **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ 3: Follow-up (LLM à¸•à¸­à¸š YES)**
```
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 1: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2: "à¹à¸¥à¹‰à¸§à¸à¸²à¸£à¹€à¸‡à¸´à¸™à¸‚à¸­à¸‡à¸‰à¸±à¸™à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸¢à¸±à¸‡à¹„à¸‡"

Flow:
1. Early Exit Check #1 â†’ à¸¡à¸µ last_question â†’ à¹„à¸›à¸•à¹ˆà¸­
2. Early Exit Check #2 â†’ à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ â†’ à¹„à¸›à¸•à¹ˆà¸­
3. à¹ƒà¸Šà¹‰ LLM â†’ à¸•à¸­à¸š "YES" (à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸šà¸£à¸²à¸¨à¸µà¸—à¸µà¹ˆà¹„à¸”à¹‰)
4. is_follow_up_question = True âœ…
```

#### **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ 4: New Question (LLM à¸•à¸­à¸š NO)**
```
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 1: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2: "à¸£à¸²à¸¨à¸µà¹€à¸¡à¸©à¸¡à¸µà¸¥à¸±à¸à¸©à¸“à¸°à¸¢à¸±à¸‡à¹„à¸‡"

Flow:
1. Early Exit Check #1 â†’ à¸¡à¸µ last_question â†’ à¹„à¸›à¸•à¹ˆà¸­
2. Early Exit Check #2 â†’ à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ â†’ à¹„à¸›à¸•à¹ˆà¸­
3. à¹ƒà¸Šà¹‰ LLM â†’ à¸•à¸­à¸š "NO" (à¹„à¸¡à¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡)
4. is_new_question = True âœ…
```

#### **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ 5: Follow-up (Semantic Similarity)**
```
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 1: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2: "à¹à¸¥à¹‰à¸§à¸„à¸§à¸²à¸¡à¸£à¸±à¸à¸‚à¸­à¸‡à¸‰à¸±à¸™à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸¢à¸±à¸‡à¹„à¸‡"

Flow:
1. Early Exit Check #1 â†’ à¸¡à¸µ last_question â†’ à¹„à¸›à¸•à¹ˆà¸­
2. Early Exit Check #2 â†’ à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ â†’ à¹„à¸›à¸•à¹ˆà¸­
3. à¹„à¸¡à¹ˆà¸¡à¸µ API Key â†’ à¹ƒà¸Šà¹‰ Semantic Similarity
4. similarity = 0.32 >= 0.25 â†’ return True
5. is_follow_up_question = True âœ…
```

---

#### **ðŸ” Step 1: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™ (Early Exit)**

**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1003-1014`

**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆ 1: à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸—**
```python
if not user_context or not user_context.get("last_question"):
    return False  # â† à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-up = à¹€à¸›à¹‡à¸™ NEW QUESTION
```

**à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆ 2: à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡**
```python
has_birth_date_in_question = any(pattern in question for pattern in [
    "/", "-", ".", "à¹€à¸”à¸·à¸­à¸™", "à¸›à¸µ", "à¸§à¸±à¸™à¹€à¸à¸´à¸”", "à¹€à¸à¸´à¸”", 
    "à¸¡à¸à¸£à¸²à¸„à¸¡", "à¸à¸¸à¸¡à¸ à¸²à¸žà¸±à¸™à¸˜à¹Œ", "à¸¡à¸µà¸™à¸²à¸„à¸¡", ... (à¸Šà¸·à¹ˆà¸­à¹€à¸”à¸·à¸­à¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”)
])

if has_birth_date_in_question:
    return False  # â† à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ follow-up = à¹€à¸›à¹‡à¸™ NEW QUESTION
```

**âœ… à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ**: à¸–à¹‰à¸²à¸œà¹ˆà¸²à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¹ƒà¸”à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸«à¸™à¸¶à¹ˆà¸‡ â†’ **à¹€à¸›à¹‡à¸™ NEW QUESTION** (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸Šà¹‡à¸à¸•à¹ˆà¸­)

---

#### **ðŸ” Step 2: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š OpenAI API Key**

**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1018-1025`

```python
openai_key = os.getenv("OPENAI_API_KEY")
if not openai_key or openai_key == "your-openai-api-key-here":
    # Fallback à¹„à¸›à¹ƒà¸Šà¹‰ Semantic Similarity
    is_follow_up, _ = check_follow_up_question_with_semantic_similarity(
        question, user_context, similarity_threshold=0.25
    )
    return is_follow_up
```

**âœ… à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ API Key**: à¹ƒà¸Šà¹‰ **Semantic Similarity** à¹à¸—à¸™ (à¸”à¸¹ Step 3)

---

#### **ðŸ” Step 3: Semantic Similarity (Fallback Method)**

**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:850-984`  
**à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™**: `check_follow_up_question_with_semantic_similarity()`

**à¸§à¸´à¸˜à¸µà¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™**:

1. **à¸ªà¸£à¹‰à¸²à¸‡ Embeddings**:
   - à¹ƒà¸Šà¹‰à¹‚à¸¡à¹€à¸”à¸¥: `SentenceTransformer("all-MiniLM-L6-v2")`
   - à¸ªà¸£à¹‰à¸²à¸‡ embedding à¸ªà¸³à¸«à¸£à¸±à¸šà¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
   - à¹ƒà¸Šà¹‰ embedding à¸—à¸µà¹ˆà¹€à¸à¹‡à¸šà¹„à¸§à¹‰à¸ªà¸³à¸«à¸£à¸±à¸šà¸„à¸³à¸–à¸²à¸¡/à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² (à¸–à¹‰à¸²à¸¡à¸µ)

2. **à¸„à¸³à¸™à¸§à¸“ Similarity**:
   ```python
   # à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸š:
   - à¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² (last_question)
   - à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² (last_response)
   - à¸šà¸£à¸´à¸šà¸—à¸£à¸§à¸¡ (last_question + last_response)
   - Recent conversations (3 à¸„à¸£à¸±à¹‰à¸‡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”)
   
   # à¸«à¸² max_similarity
   max_similarity = max(all_similarity_scores)
   ```

3. **à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆ**:
   ```python
   if max_similarity >= 0.25:
       return True   # à¹€à¸›à¹‡à¸™ follow-up
   else:
       return False  # â† à¹€à¸›à¹‡à¸™ NEW QUESTION
   ```

**âœ… à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ**: à¸–à¹‰à¸² `similarity < 0.25` â†’ **à¹€à¸›à¹‡à¸™ NEW QUESTION**

---

#### **ðŸ” Step 4: à¹ƒà¸Šà¹‰ LLM à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š (Primary Method)**

**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1029-1072`

**à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™**:

1. **à¸ªà¸£à¹‰à¸²à¸‡ Prompt**:
   ```
   à¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²: "{last_question}"
   à¸„à¸³à¸•à¸­à¸šà¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²: "{last_response[:300]}..."
   à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™: "{question}"
   
   à¸•à¸­à¸šà¸§à¹ˆà¸² "YES" à¸–à¹‰à¸²à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡ à¸«à¸£à¸·à¸­ "NO" à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡
   ```

2. **à¹€à¸£à¸µà¸¢à¸ LLM**:
   ```python
   response = client.chat.completions.create(
       model="gpt-4o-mini",
       messages=[...],
       temperature=0.1,
       max_tokens=10
   )
   ```

3. **à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆ**:
   ```python
   result = response.choices[0].message.content.strip().upper()
   is_follow_up = result == "YES"
   
   if is_follow_up:
       return True   # à¹€à¸›à¹‡à¸™ follow-up
   else:
       return False  # â† à¹€à¸›à¹‡à¸™ NEW QUESTION
   ```

**âœ… à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ**: à¸–à¹‰à¸² LLM à¸•à¸­à¸š "NO" â†’ **à¹€à¸›à¹‡à¸™ NEW QUESTION**

---

#### **ðŸ” Step 5: Error Handling**

**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1074-1084`

```python
except Exception as e:
    # Fallback à¹„à¸›à¹ƒà¸Šà¹‰ Semantic Similarity
    try:
        is_follow_up, _ = check_follow_up_question_with_semantic_similarity(...)
        return is_follow_up
    except:
        return False  # â† à¹€à¸›à¹‡à¸™ NEW QUESTION (à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸£à¸°à¸šà¸šà¸—à¸³à¸‡à¸²à¸™à¸•à¹ˆà¸­à¹„à¸”à¹‰)
```

**âœ… à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ**: à¸–à¹‰à¸²à¹€à¸à¸´à¸” error à¸—à¸±à¹‰à¸‡ LLM à¹à¸¥à¸° Semantic Similarity â†’ **à¹€à¸›à¹‡à¸™ NEW QUESTION** (default)

---

#### **ðŸ” Step 6: Override Follow-up Status (Post-Processing)**

**à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡**: `retrieval_utils.py:1111-1128`

à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¹„à¸”à¹‰ `is_follow_up_question` à¹à¸¥à¹‰à¸§ à¸£à¸°à¸šà¸šà¸ˆà¸° override à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡:

**Override 1** (à¸šà¸£à¸£à¸—à¸±à¸” 1111):
```python
if provided_chart_info:
    is_follow_up_question = False  # â† à¹€à¸›à¹‡à¸™ NEW QUESTION
```

**Override 2** (à¸šà¸£à¸£à¸—à¸±à¸” 1122):
```python
if birth_info_from_question and birth_info_from_question.get('date'):
    is_follow_up_question = False  # â† à¹€à¸›à¹‡à¸™ NEW QUESTION
```

**Override 3** (à¸šà¸£à¸£à¸—à¸±à¸” 1118):
```python
if is_follow_up_question and not user_context and not birth_info:
    is_follow_up_question = False  # â† à¹€à¸›à¹‡à¸™ NEW QUESTION
```

**Override 4** (à¸šà¸£à¸£à¸—à¸±à¸” 1128):
```python
if is_follow_up_question and user_context and not user_zodiac and not birth_info:
    is_follow_up_question = False  # â† à¹€à¸›à¹‡à¸™ NEW QUESTION
```

---

### **ðŸ“Š à¸ªà¸£à¸¸à¸›à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™ New Question**

| à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚ | à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ | à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ |
|---------|---------|---------|
| à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸— (à¹„à¸¡à¹ˆà¸¡à¸µ `last_question`) | `retrieval_utils.py:1003` | âœ… NEW QUESTION |
| à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ (pattern matching) | `retrieval_utils.py:1007-1014` | âœ… NEW QUESTION |
| Semantic Similarity < 0.25 | `retrieval_utils.py:970` | âœ… NEW QUESTION |
| LLM à¸•à¸­à¸š "NO" | `retrieval_utils.py:1065` | âœ… NEW QUESTION |
| à¸¡à¸µ `provided_chart_info` | `retrieval_utils.py:1111` | âœ… NEW QUESTION |
| à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ (à¸«à¸¥à¸±à¸‡ extract) | `retrieval_utils.py:1122` | âœ… NEW QUESTION |
| à¹€à¸›à¹‡à¸™ follow-up à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸— | `retrieval_utils.py:1118` | âœ… NEW QUESTION |
| à¹€à¸›à¹‡à¸™ follow-up à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¨à¸µ | `retrieval_utils.py:1128` | âœ… NEW QUESTION |
| Error à¸—à¸±à¹‰à¸‡ LLM à¹à¸¥à¸° Semantic | `retrieval_utils.py:1083` | âœ… NEW QUESTION |

---

### **ðŸŽ¯ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™**

#### **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ 1: New Question (à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸£à¸´à¸šà¸—)**
```
à¸„à¸³à¸–à¸²à¸¡: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"
user_context: None (à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹ƒà¸«à¸¡à¹ˆ)

Flow:
1. get_user_context() â†’ None
2. check_follow_up_question_with_llm() â†’ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š
3. à¹„à¸¡à¹ˆà¸¡à¸µ last_question â†’ return False
4. is_new_question = True âœ…
```

#### **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ 2: New Question (à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸«à¸¡à¹ˆ)**
```
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 1: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2: "15/03/1990 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"  â† à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸«à¸¡à¹ˆ

Flow:
1. get_user_context() â†’ à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ MongoDB
   - user_context = {
       "birth_date": "09/02/2004",
       "zodiac_sign": "à¸à¸¸à¸¡à¸ à¹Œ",
       "last_question": "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£",
       ...
   }

2. check_follow_up_question_with_llm() â†’ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š
   - à¸žà¸š pattern "/" à¹à¸¥à¸° "à¸›à¸µ" à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2
   - return False à¸—à¸±à¸™à¸—à¸µ (à¹„à¸¡à¹ˆà¹€à¸£à¸µà¸¢à¸ LLM, à¹„à¸¡à¹ˆà¹€à¸Šà¹‡à¸à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹€à¸”à¸´à¸¡à¸«à¸£à¸·à¸­à¹ƒà¸«à¸¡à¹ˆ)

3. extract_birth_info_from_message() â†’ à¹à¸¢à¸à¸§à¸±à¸™à¹€à¸à¸´à¸”à¸ˆà¸²à¸à¸„à¸³à¸–à¸²à¸¡
   - birth_info_from_question = {"date": "15/03/1990"}

4. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š (retrieval_utils.py:1121-1123):
   ```python
   if birth_info_from_question and birth_info_from_question.get('date'):
       is_follow_up_question = False  # â† à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸Šà¹‡à¸à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸«à¸¡à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
       # à¹à¸„à¹ˆà¹€à¸Šà¹‡à¸à¸§à¹ˆà¸²à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
   ```

5. à¸ªà¸£à¹‰à¸²à¸‡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¹ƒà¸«à¸¡à¹ˆ (retrieval_utils.py:1138-1144):
   ```python
   if not astrology_chart and birth_info_from_question and birth_info_from_question['date']:
       astrology_chart = generate_detailed_astrology_reading(question)
       # à¸ªà¸£à¹‰à¸²à¸‡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¹ƒà¸«à¸¡à¹ˆà¸ˆà¸²à¸ "15/03/1990" â†’ à¸£à¸²à¸¨à¸µà¸¡à¸µà¸™
   ```

6. à¸­à¸±à¸›à¹€à¸”à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™ MongoDB (store_user_response):
   - à¸­à¸±à¸›à¹€à¸”à¸• user_profiles.birth_date = "15/03/1990"
   - à¸­à¸±à¸›à¹€à¸”à¸• user_profiles.zodiac_sign = "à¸¡à¸µà¸™"

7. is_new_question = True âœ…

**à¸ªà¸£à¸¸à¸›**: à¸£à¸°à¸šà¸šà¹„à¸¡à¹ˆà¹€à¸Šà¹‡à¸à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸«à¸¡à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ à¹à¸„à¹ˆà¹€à¸Šà¹‡à¸à¸§à¹ˆà¸² "à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ"
- à¸–à¹‰à¸²à¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ â†’ à¸–à¸·à¸­à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ new question à¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¹ƒà¸«à¸¡à¹ˆ
- à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸šà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹€à¸”à¸´à¸¡à¹ƒà¸™ MongoDB (à¹ƒà¸™à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™ ask_question_to_rag)
```

#### **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ 3: New Question (LLM à¸•à¸­à¸š NO)**
```
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 1: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2: "à¸£à¸²à¸¨à¸µà¹€à¸¡à¸©à¸¡à¸µà¸¥à¸±à¸à¸©à¸“à¸°à¸¢à¸±à¸‡à¹„à¸‡"  â† à¸–à¸²à¸¡à¹€à¸£à¸·à¹ˆà¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ

Flow:
1. get_user_context() â†’ à¸¡à¸µ last_question
2. à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸™à¸„à¸³à¸–à¸²à¸¡ â†’ à¹„à¸›à¸•à¹ˆà¸­
3. à¹€à¸£à¸µà¸¢à¸ LLM â†’ à¸•à¸­à¸š "NO" (à¹„à¸¡à¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡)
4. is_new_question = True âœ…
```

#### **à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ 4: New Question (Semantic Similarity < 0.25)**
```
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 1: "09/02/2004 à¸£à¸²à¸¨à¸µà¸­à¸°à¹„à¸£"
à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ 2: "à¸£à¸²à¸¨à¸µà¹€à¸¡à¸©à¸¡à¸µà¸¥à¸±à¸à¸©à¸“à¸°à¸¢à¸±à¸‡à¹„à¸‡"  â† similarity: 0.15

Flow:
1. get_user_context() â†’ à¸¡à¸µ last_question
2. à¹„à¸¡à¹ˆà¸¡à¸µ API Key â†’ à¹ƒà¸Šà¹‰ Semantic Similarity
3. similarity = 0.15 < 0.25 â†’ return False
4. is_new_question = True âœ…
```

---

### **âš™ï¸ Configuration**

**Thresholds:**
- **Semantic Similarity Threshold**: `0.25` (à¸›à¸£à¸±à¸šà¹„à¸”à¹‰à¹ƒà¸™ `similarity_threshold`)
- **LLM Temperature**: `0.1` (à¸•à¹ˆà¸³à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸ªà¸¡à¹ˆà¸³à¹€à¸ªà¸¡à¸­)
- **LLM Max Tokens**: `10` (à¹€à¸žà¸µà¸¢à¸‡à¸žà¸­à¸ªà¸³à¸«à¸£à¸±à¸š YES/NO)

**Models:**
- **LLM**: `gpt-4o-mini` (default) à¸«à¸£à¸·à¸­à¸•à¸²à¸¡ `OPENAI_MODEL` env
- **Embedding**: `all-MiniLM-L6-v2` (SentenceTransformer)

**Environment Variables:**
- `OPENAI_API_KEY`: à¸ˆà¸³à¹€à¸›à¹‡à¸™à¸ªà¸³à¸«à¸£à¸±à¸š LLM detection
- `OPENAI_MODEL`: à¹‚à¸¡à¹€à¸”à¸¥à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰ (default: `gpt-4o-mini`)

---

## âš™ï¸ Configuration & Settings

### **Environment Variables:**
- `OPENAI_API_KEY`: API key à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸£à¸µà¸¢à¸ LLM (à¸ˆà¸³à¹€à¸›à¹‡à¸™à¸ªà¸³à¸«à¸£à¸±à¸š follow-up detection)
- `OPENAI_MODEL`: à¹‚à¸¡à¹€à¸”à¸¥à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰ (default: `gpt-4o-mini`)

### **Thresholds:**
- **Semantic Similarity Threshold**: `0.25` (à¸›à¸£à¸±à¸šà¹„à¸”à¹‰à¹ƒà¸™ `check_follow_up_question_with_semantic_similarity()`)
- **LLM Temperature**: `0.1` (à¸•à¹ˆà¸³à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸ªà¸¡à¹ˆà¸³à¹€à¸ªà¸¡à¸­)
- **LLM Max Tokens**: `10` (à¹€à¸žà¸µà¸¢à¸‡à¸žà¸­à¸ªà¸³à¸«à¸£à¸±à¸š YES/NO)

### **Embedding Model:**
- **Model**: `all-MiniLM-L6-v2` (SentenceTransformer)
- **Dimension**: 384 dimensions
- **Usage**: à¹ƒà¸Šà¹‰à¸ªà¸³à¸«à¸£à¸±à¸š semantic similarity fallback

