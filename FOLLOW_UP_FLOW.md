# Flow ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πÑ‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (Follow-up)

## ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ LLM (OpenAI) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô follow-up ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ keyword fallback

---

## üîÑ Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°                                          ‚îÇ
‚îÇ     "‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á"                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. ask_question_to_rag() ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô                          ‚îÇ
‚îÇ     - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î)                          ‚îÇ
‚îÇ     - ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏à‡∏≤‡∏Å MongoDB                              ‚îÇ
‚îÇ       get_user_context(user_id)                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Follow-up                                       ‚îÇ
‚îÇ     check_follow_up_question_with_llm()                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                         ‚îÇ
        ‚ñº                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 1    ‚îÇ    ‚îÇ  ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 2      ‚îÇ
‚îÇ  ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó?      ‚îÇ    ‚îÇ  ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°?  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                      ‚îÇ
   YES ‚îÇ                  YES ‚îÇ
       ‚îÇ                      ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
             return False
                  ‚îÇ
                  ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  ‡πÉ‡∏ä‡πâ LLM ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö  ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ         ‚îÇ
            ‚ñº         ‚ñº
      return True  return False
        (YES)       (NO)
```

---

## üìã Step-by-Step Flow

### **Phase 1: ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•**

#### Step 1.1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
```python
is_allowed, current_count, limit_message = check_and_update_question_limit(user_id)
if not is_allowed:
    return limit_message  # ‚Üê ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î
```
**‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô**: `ask_question_to_rag()` (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 872-876)  
**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå**: ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°

---

#### Step 1.2: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏ö‡∏ó
```python
user_context = get_user_context(user_id)
```
**‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô**: `get_user_context()` (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 238-349)  
**‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å MongoDB**:
- `user_profiles`: ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î, ‡∏£‡∏≤‡∏®‡∏µ, ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°/‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
- `responses`: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á user_context**:
```python
{
    "zodiac_sign": "‡∏Å‡∏∏‡∏°‡∏†‡πå",
    "birth_date": "09/02/2004",
    "last_question": "09/02/2004 ‡∏£‡∏≤‡∏®‡∏µ‡∏≠‡∏∞‡πÑ‡∏£",
    "last_response": "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏®‡∏µ‡∏Å‡∏∏‡∏°‡∏†‡πå...",
    "recent_conversations": [...]
}
```

---

### **Phase 2: ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Follow-up**

#### Step 2.1: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
```python
is_follow_up_question = check_follow_up_question_with_llm(question, user_context)
```
**‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô**: `check_follow_up_question_with_llm()` (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 793-867)

---

#### Step 2.2: ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 1 - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏£‡∏¥‡∏ö‡∏ó
```python
if not user_context or not user_context.get("last_question"):
    return False  # ‚Üê ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà follow-up
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 806-807  
**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå**: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ ‚Üí `return False`

---

#### Step 2.3: ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 2 - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
```python
has_birth_date_in_question = any(pattern in question for pattern in [
    "/", "-", ".", "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "‡∏õ‡∏µ", "‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î", "‡πÄ‡∏Å‡∏¥‡∏î", 
    "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", ..., "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
]

if has_birth_date_in_question:
    return False  # ‚Üê ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà follow-up
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 810-817  
**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå**: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‚Üí `return False` (‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà)

---

#### Step 2.4: ‡πÉ‡∏ä‡πâ LLM ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á

**‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á 2 ‚Üí ‡πÉ‡∏ä‡πâ LLM ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö**

```python
# ‡∏™‡∏£‡πâ‡∏≤‡∏á prompt
prompt = f"""
‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤: "{last_question}"
‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤: "{last_response[:200]}..."
‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: "{question}"

‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ "YES" ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ "NO"
"""
```

**‡πÄ‡∏£‡∏µ‡∏¢‡∏Å LLM**:
```python
response = client.chat.completions.create(
    model=openai_model,  # gpt-4o-mini (default)
    messages=[...],
    temperature=0.1,
    max_tokens=10
)

result = response.choices[0].message.content.strip().upper()
is_follow_up = result == "YES"
```

**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 846-857  
**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå**: 
- `"YES"` ‚Üí `return True` (‡πÄ‡∏õ‡πá‡∏ô follow-up)
- `"NO"` ‚Üí `return False` (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà follow-up)

---

#### Step 2.5: Error Handling
```python
except Exception as e:
    logger.warning(f"Error in LLM follow-up check: {e}")
    return False  # ‚Üê ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà follow-up (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ)
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 863-867  
**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå**: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‚Üí `return False`

---

### **Phase 3: ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤**

#### Step 3.1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
```python
birth_info_from_question = extract_birth_info_from_message(question)
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 888

---

#### Step 3.2: Override Follow-up Status (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ provided_chart_info)
```python
if provided_chart_info:
    astrology_chart = provided_chart_info
    is_follow_up_question = False  # ‚Üê ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ chart_info ‡πÉ‡∏´‡∏°‡πà = ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà follow-up
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 892-895

---

#### Step 3.3: Override Follow-up Status (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó)
```python
if is_follow_up_question and not user_context and not birth_info_from_question:
    is_follow_up_question = False
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 899-900

---

#### Step 3.4: Override Follow-up Status (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)
```python
if birth_info_from_question and birth_info_from_question.get('date'):
    is_follow_up_question = False  # ‚Üê ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà = ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà follow-up
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 903-905

---

#### Step 3.5: Override Follow-up Status (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏®‡∏µ‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏ó)
```python
if is_follow_up_question and user_context and not user_zodiac and not birth_info_from_question:
    is_follow_up_question = False
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 909-910

---

#### Step 3.6: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤

**‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà)**
```python
if not astrology_chart and birth_info_from_question and birth_info_from_question['date']:
    astrology_chart = generate_detailed_astrology_reading(question)
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 920-928

**‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏õ‡πá‡∏ô Follow-up ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏£‡∏≤‡∏®‡∏µ‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏ó**
```python
elif not astrology_chart and user_context and user_zodiac and is_follow_up_question:
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á astrology_chart ‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏ö‡∏ó (‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà)
    astrology_chart = {
        'zodiac_sign': user_zodiac,
        'zodiac_element': user_context.get('zodiac_element'),
        'birth_date': user_birth_date,
        ...
    }
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 929-948

---

### **Phase 4: ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°**

#### Step 4.1: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
```python
question_intent = analyze_question_intent(question)
# ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô personality, love, career, health, finance, lucky_colors ‡∏´‡∏£‡∏∑‡∏≠ general
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 972

---

#### Step 4.2: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
```python
enhanced_question = enhance_question_context(question, user_context)
```
**‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô**: `enhance_question_context()` (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 506-651)

**‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô**:
1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡πÄ‡∏ä‡πà‡∏ô "‡∏£‡∏≤‡∏®‡∏µ‡∏ô‡∏µ‡πâ", "‡∏ô‡∏¥‡∏™‡∏±‡∏¢", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å")
2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏®‡∏µ‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏ö‡∏ó (‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á):
   - `user_context.zodiac_sign`
   - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å `user_context.birth_date`
   - ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å `recent_conversations`
   - ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å `last_conversation.answer`
3. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:
   - "‡∏£‡∏≤‡∏®‡∏µ‡∏ô‡∏µ‡πâ" ‚Üí "‡∏£‡∏≤‡∏®‡∏µ‡∏Å‡∏∏‡∏°‡∏†‡πå"
   - "‡∏ô‡∏¥‡∏™‡∏±‡∏¢" ‚Üí "‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡∏£‡∏≤‡∏®‡∏µ‡∏Å‡∏∏‡∏°‡∏†‡πå"
   - "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å" ‚Üí "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏£‡∏≤‡∏®‡∏µ‡∏Å‡∏∏‡∏°‡∏†‡πå"

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á**:
```
‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°: "‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á"
‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: "‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏®‡∏µ‡∏Å‡∏∏‡∏°‡∏†‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á"
```

---

### **Phase 5: ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (RAG)**

#### Step 5.1: ‡∏™‡∏£‡πâ‡∏≤‡∏á Query Embedding
```python
model = SentenceTransformer("all-MiniLM-L6-v2")
query_embedding = model.encode(enhanced_question)
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 1008-1009

---

#### Step 5.2: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å MongoDB Collections
```python
collections_to_search = [
    "processed_text_chunks",
    "processed_image_chunks",
    "processed_table_chunks",
]
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 1014-1018

**‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô**:
- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì similarity scores
- ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ similarity ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
- Threshold: similarity > 0.2

---

### **Phase 6: ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö**

#### Step 6.1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key
```python
openai_key = os.getenv("OPENAI_API_KEY")
if not openai_key or openai_key == "your-openai-api-key-here":
    return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å..."
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 1100-1103

---

#### Step 6.2: ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt

**‡∏™‡∏£‡πâ‡∏≤‡∏á context_info ‡∏à‡∏≤‡∏Å retrieved_docs**:
```python
if retrieved_docs:
    context_info = "\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• astrobot_summary:\n"
    for doc in retrieved_docs:
        context_info += f"{i+1}. {doc.get('summary', '')[:300]}...\n"
```

**‡∏™‡∏£‡πâ‡∏≤‡∏á chart_info ‡∏à‡∏≤‡∏Å astrology_chart**:
```python
if astrology_chart:
    chart_info = f"""
    ‡∏£‡∏≤‡∏®‡∏µ‡πÄ‡∏Å‡∏¥‡∏î: {astrology_chart['zodiac_sign']}
    ‡∏ò‡∏≤‡∏ï‡∏∏: {astrology_chart['zodiac_element']}
    ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: {astrology_chart['birth_date']}
    ...
    """
```

**‡∏™‡∏£‡πâ‡∏≤‡∏á astrology_prompt**:
```python
astrology_prompt = f"""
‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏£‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•...
{focus_instruction}  # ‡∏ï‡∏≤‡∏°‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
{birth_info}          # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
{chart_info}          # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤
{context_info}        # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å RAG
{get_conversation_context(user_context)}  # ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: {enhanced_question}
"""
```

---

#### Step 6.3: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å LLM ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
```python
response = client.chat.completions.create(
    model=openai_model,  # gpt-4o-mini (default)
    messages=[
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": astrology_prompt}
    ],
    temperature=0.8,
    max_tokens=1000
)

answer = response.choices[0].message.content
```
**‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î**: 1418-1429

---

### **Phase 7: ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•**

#### Step 7.1: ‡∏™‡∏£‡πâ‡∏≤‡∏á Context Data
```python
context_data = {}
if astrology_chart:
    context_data.update({
        "zodiac_sign": astrology_chart.get('zodiac_sign'),
        "zodiac_element": astrology_chart.get('zodiac_element'),
        "birth_date": astrology_chart.get('birth_date'),
        ...
    })
```

---

#### Step 7.2: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
```python
store_user_response(
    question=question,
    answer=answer,
    user_id=user_id,
    response_type="rag_response",
    context_data=context_data
)
```
**‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô**: `store_user_response()` (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 108-193)

**‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å**:
1. **`responses` collection**: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
2. **`user_profiles` collection**: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
   - `last_question`: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
   - `last_response`: ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
   - `zodiac_sign`, `birth_date`, ... : ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏®‡∏µ

---

## üìä ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 1: Follow-up ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

```
‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 1:
‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "09/02/2004 ‡∏£‡∏≤‡∏®‡∏µ‡∏≠‡∏∞‡πÑ‡∏£"
‚Üì
‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: {
    zodiac_sign: "‡∏Å‡∏∏‡∏°‡∏†‡πå",
    last_question: "09/02/2004 ‡∏£‡∏≤‡∏®‡∏µ‡∏≠‡∏∞‡πÑ‡∏£",
    last_response: "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏®‡∏µ‡∏Å‡∏∏‡∏°‡∏†‡πå..."
}

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 2:
‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á"
‚Üì
Step 1: ‡∏î‡∏∂‡∏á‡∏ö‡∏£‡∏¥‡∏ö‡∏ó ‚Üí ‡πÑ‡∏î‡πâ zodiac_sign = "‡∏Å‡∏∏‡∏°‡∏†‡πå"
Step 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö follow-up
  - ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó ‚úÖ
  - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‚úÖ
  - LLM ‡∏ï‡∏≠‡∏ö "YES" ‚úÖ
  ‚Üí is_follow_up_question = True
Step 3: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏ö‡∏ó ‚Üí ‡∏£‡∏≤‡∏®‡∏µ‡∏Å‡∏∏‡∏°‡∏†‡πå
Step 4: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‚Üí "‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏®‡∏µ‡∏Å‡∏∏‡∏°‡∏†‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á"
Step 5: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‚Üí "‡∏£‡∏≤‡∏®‡∏µ‡∏Å‡∏∏‡∏°‡∏†‡πå‡∏°‡∏µ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô..."
Step 6: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏£‡∏¥‡∏ö‡∏ó
```

---

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 2: ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Follow-up

```
‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á" (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó)
‚Üì
Step 1: ‡∏î‡∏∂‡∏á‡∏ö‡∏£‡∏¥‡∏ö‡∏ó ‚Üí user_context = None
Step 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö follow-up
  - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó ‚ùå
  ‚Üí return False
  ‚Üí is_follow_up_question = False
Step 3: ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î)
Step 4: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‚Üí "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô..."
```

---

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 3: ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Follow-up)

```
‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: "15/03/1990 ‡∏£‡∏≤‡∏®‡∏µ‡∏≠‡∏∞‡πÑ‡∏£" (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà)
‚Üì
Step 1: ‡∏î‡∏∂‡∏á‡∏ö‡∏£‡∏¥‡∏ö‡∏ó ‚Üí ‡∏°‡∏µ user_context (‡πÄ‡∏Ñ‡∏¢‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô)
Step 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö follow-up
  - ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó ‚úÖ
  - ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‚ùå ("/" ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)
  ‚Üí return False (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 817)
  ‚Üí is_follow_up_question = False
Step 3: Override Follow-up Status (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 903-905)
  - birth_info_from_question['date'] = "15/03/1990" ‚úÖ
  ‚Üí is_follow_up_question = False (override ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
Step 4: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 920-928)
  - astrology_chart = generate_detailed_astrology_reading(question)
  - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏®‡∏µ‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏≤‡∏®‡∏µ‡πÄ‡∏°‡∏©)
Step 5: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (enhance_question_context)
  - ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏à‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)
Step 6: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
  - ‡πÉ‡∏ä‡πâ astrology_chart ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
  - ‡∏ï‡∏≠‡∏ö: "‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: 15/03/1990\n‡∏£‡∏≤‡∏®‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ ‡∏£‡∏≤‡∏®‡∏µ‡πÄ‡∏°‡∏©..."
Step 7: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï user_profiles
  - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: birth_date = "15/03/1990", zodiac_sign = "‡πÄ‡∏°‡∏©"
  - ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏®‡∏µ "‡πÄ‡∏°‡∏©" ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏ó
```

**Flow ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î**:

1. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Follow-up (check_follow_up_question_with_llm)**:
   ```
   ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: "15/03/1990 ‡∏£‡∏≤‡∏®‡∏µ‡∏≠‡∏∞‡πÑ‡∏£"
   ‚Üì
   ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 1: ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó? ‚Üí ‚úÖ ‡∏°‡∏µ user_context
   ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 2: ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î? ‚Üí ‚úÖ ‡∏°‡∏µ "/" ‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
   ‚Üí return False (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ LLM ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)
   ```

2. **Override Follow-up Status (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 903-905)**:
   ```python
   birth_info_from_question = extract_birth_info_from_message(question)
   # ‚Üí {"date": "15/03/1990", "time": None, ...}
   
   if birth_info_from_question and birth_info_from_question.get('date'):
       is_follow_up_question = False  # ‚Üê Override ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
   ```

3. **‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 920-928)**:
   ```python
   if not astrology_chart and birth_info_from_question and birth_info_from_question['date']:
       # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà
       astrology_chart = generate_detailed_astrology_reading(question)
       # ‚Üí {"zodiac_sign": "‡πÄ‡∏°‡∏©", "zodiac_element": "‡πÑ‡∏ü", ...}
   ```

4. **‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1517-1521)**:
   ```python
   if birth_info_from_question and birth_info_from_question['date']:
       context_data["birth_date"] = birth_info_from_question['date']
       # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô user_profiles ‚Üí ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ
   ```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå**:
- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà follow-up (‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÄ‡∏Å‡πà‡∏≤)
- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô user_profiles
- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏®‡∏µ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏ó

---

## üîë ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç

1. **2 ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏´‡∏•‡∏±‡∏Å**: 
   - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó ‚Üí ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà follow-up
   - ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‚Üí ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà follow-up

2. **‡πÉ‡∏ä‡πâ LLM ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô**: 
   - ‡πÑ‡∏°‡πà‡∏°‡∏µ keyword fallback
   - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ API key ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

3. **‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error**: 
   - ‡∏ñ‡πâ‡∏≤ LLM error ‚Üí return False (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà follow-up)
   - ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ

4. **‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤**: 
   - Follow-up ‚Üí ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏ö‡∏ó (‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà)
   - ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î

5. **‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°**: 
   - ‡πÅ‡∏õ‡∏•‡∏á "‡∏£‡∏≤‡∏®‡∏µ‡∏ô‡∏µ‡πâ" ‚Üí "‡∏£‡∏≤‡∏®‡∏µ{user_zodiac}"
   - ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô

6. **‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å**: 
   - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏£‡∏¥‡∏ö‡∏ó
   - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ

---

## ‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á

1. **‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ API key**: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ API key ‚Üí ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à follow-up ‡πÑ‡∏î‡πâ
2. **‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó**: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó ‚Üí ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà follow-up ‡πÄ‡∏™‡∏°‡∏≠
3. **‡∏Å‡∏≤‡∏£ Override**: ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà override `is_follow_up_question`
4. **Error Handling**: ‡∏ñ‡πâ‡∏≤ LLM error ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà follow-up

